  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <div class="card">
    <div class="card-body">
      <h5 class="card-title">Commercial Partnerships</h5>
      <form class="row g-3">
      <input type="hidden" class="TRACKING_FORM form-control" id="nameID" required="">
      <div class="col-md-4">
        <label for="nameRCU" class="form-label">RCU</label>
        <input type="text" class="TRACKING_FORM form-control" id="nameRCU" required="" disabled style=" padding: 10px; background-color: #b3e6cc;">
      </div>
      <div class="col-md-4">
        <label for="namePCU" class="form-label">PCU</label>
        <input type="text" class="TRACKING_FORM form-control" id="namePCU" required="" disabled style=" padding: 10px; background-color: #b3e6cc;">
      </div>
      <div class="col-md-4">
        <label for="nameCOMMODITY" class="form-label">Commodity</label>
        <input type="text" class="TRACKING_FORM form-control" id="nameCOMMODITY" disabled style=" padding: 10px; background-color: #b3e6cc;">
      </div>
      <div class="col-md-3">
        <label for="nameDIP" class="form-label">Name of DIP</label>
        <input type="text" class="TRACKING_FORM form-control" id="nameDIP" disabled style=" padding: 10px; background-color: #b3e6cc;">
      </div>
      <div class="col-md-3">
        <label for="nameFO" class="form-label">Name of F.O</label>
        <input type="text" class="TRACKING_FORM form-control" id="nameFO" disabled style=" padding: 10px; background-color: #b3e6cc;">
      </div>
      <div class="col-md-6">
        <label for="addressFO" class="form-label">Address (F.O) </label>
        <input type="text" class="TRACKING_FORM form-control" id="addressFO"  disabled style=" padding: 10px; background-color: #b3e6cc;">
      </div>
      <div class="col-md-6">
        <label for="af-msme" class="form-label">Anchor Firm/MSME </label>
        <input type="text" class="TRACKING_FORM form-control" id="af-msme"  disabled style=" padding: 10px; background-color: #b3e6cc;">
      </div>
      </form>
    </div>
    </div>

    <div class="card">
    <div class="card-body">
      <h5 class="card-title">Yearly Sales Tracker</h5>
      <form class="row g-3" id="yearlySalesTrackerForm">
      <div class="col-md-3">
        <label for="productType" class="form-label">Product Type</label>
        <select class="TRACKING_FORM form-control" id="productType" required style="border: 2px solid #c2bfbf; padding: 10px;">
          <option value="">Choose your option</option>
  
          <optgroup label="Coconut">
              <option value="Coconut - Whole Nuts">Whole Nuts</option>
              <option value="Coconut - Copra">Copra</option>
              <option value="Coconut - White Copra">White Copra</option>
          </optgroup>
  
          <optgroup label="Cacao">
              <option value="Cacao - Wet Beans">Wet Beans</option>
              <option value="Cacao - Dried Beans">Dried Beans</option>
              <option value="Cacao - Dried Fermented Beans">Dried Fermented Beans</option>
          </optgroup>
  
          <optgroup label="Coffee">
              <option value="Coffee - Red Cherries">Red Cherries</option>
              <option value="Coffee - Green Coffee Beans">Green Coffee Beans</option>
          </optgroup>
  
          <optgroup label="Banana">
              <option value="Banana - Green Cardava Banana">Green Cardava Banana</option>
              <option value="Banana - Banana Chips">Banana Chips</option>
              <option value="Banana - Vacuum Sealed Banana">Vacuum Sealed Banana</option>
          </optgroup>
      </select>
      </div>
      <div class="col-md-3">
        <label for="vs" class="form-label">Vol. Supplied</label>
        <input type="number" class="TRACKING_FORM form-control" id="vs" required="" placeholder="Input vol. supplied" style="border: 2px solid #c2bfbf; padding: 10px;">
      </div>
      <div class="col-md-3">
        <label for="aveP" class="form-label">Ave Price</label>
        <input type="number" class="TRACKING_FORM form-control" id="aveP" required="" placeholder="Input average price" style="border: 2px solid #c2bfbf; padding: 10px;">
      </div>
      <div class="col-md-3">
        <label for="totalTransaction" class="form-label">Total Transaction</label>
        <input type="number" class="TRACKING_FORM form-control" id="totalTransaction" required="" placeholder="Input Total transaction" style="border: 2px solid #c2bfbf; padding: 10px;">
      </div>
      <div class="col-md-4">
        <label for="incentives" class="form-label">Incentives Provided</label>
        <input type="text" class="TRACKING_FORM form-control" id="incentives" required="" placeholder="Input incentives provided" style="border: 2px solid #c2bfbf; padding: 10px;">
      </div>
      <div class="col-md-2">
        <label for="date" class="form-label">Date</label>
        <input type="date" class="TRACKING_FORM form-control" id="date" required="" placeholder="Input incentives provided" style="border: 2px solid #c2bfbf; padding: 10px;">
      </div>
      </form>
      <br>
      <div class="text-center">
      <button type="button" class="btn btn-primary" onclick="submitSalesTracker()">Submit</button>
      <button type="reset" class="btn btn-secondary" onclick="document.getElementById('yearlySalesTrackerForm').reset();">Clear</button>
      </div>
    </div>
    </div>

    <input type="hidden" id="upload_by" class="TRACKING_FORM" value="">

        <script>
        document.addEventListener("DOMContentLoaded", function () {
            fetch("/mis-v4/get-session")
                .then(response => response.json())
                .then(data => {
                    const createdByField = document.getElementById("upload_by");
                    if (data && data[0] && data[0].id) {
                        createdByField.value = data[0].id;
                    }
                })
                .catch(error => console.error("Error fetching user data:", error));
        });
        </script>

    <script>
      const swalWithCustomButtons = Swal.mixin({
        customClass: {
          confirmButton: 'btn btn-success',
          cancelButton: 'btn btn-danger'
        },
        buttonsStyling: false
      });
      function submitSalesTracker() {
        const trackerInputs = document.querySelectorAll("#yearlySalesTrackerForm .TRACKING_FORM");
        let isValid = true;
        trackerInputs.forEach(input => {
            if (!input.value.trim()) {
                input.style.border = "2px solid red";
                isValid = false;
            } else {
                input.style.border = "2px solid #c2bfbf";
            }
        });
        if (!isValid) {
            swalWithCustomButtons.fire({
                title: "Error!",
                text: "Please fill in all required fields before submitting.",
                icon: "error",
                confirmButtonText: "OK"
            });
            return;
        }
        let formData = new FormData();
        const cpaId = document.getElementById("nameID").value;
        formData.append("record_id", cpaId);
        const allInputs = document.querySelectorAll(".TRACKING_FORM");
        allInputs.forEach(input => {
            formData.append(input.id, input.value);
        });
        fetch("/micro/insert_sales_tracker", {
            method: "POST",
            body: formData
        })
        .then(response => response.json())
          .then(data => {
            if (data.status === "success") {
                const newId = data.id || cpaId; 
                document.getElementById('yearlySalesTrackerForm').reset();
                swalWithCustomButtons.fire({
                    title: "Success!",
                    text: "Your record has been successfully submitted.",
                    icon: "success",
                    confirmButtonText: "OK"
                }).then(() => {
                    window.location.href = `/mis-v4/core-table-sales-tracker?tbl=dcf_implementing_unit&id=${newId}`;
                });
            } else {
                swalWithCustomButtons.fire({
                    title: "Error!",
                    text: data.message,
                    icon: "error",
                    confirmButtonText: "OK"
                });
            }
        })
        .catch(error => {
            console.error("Error:", error);
            swalWithCustomButtons.fire({
                title: "Error!",
                text: "Something went wrong. Please try again.",
                icon: "error",
                confirmButtonText: "OK"
            });
        });
    }
    </script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
      const urlParams = new URLSearchParams(window.location.search);
      const st_id = urlParams.get("st_id");
      const isView = urlParams.get("view") === "true";
      const isEdit = urlParams.get("edit") === "true";
  
      if (st_id) {
          fetch(`/view-sales-tracker-table/${st_id}`)
              .then((response) => response.json())
              .then((data) => {
                  if (data.status === "error") {
                      console.error(data.message);
                      return;
                  }
                  function formatDate(dateString) {
                      if (!dateString) return "";
                      const date = new Date(dateString);
                      const year = date.getFullYear();
                      const month = String(date.getMonth() + 1).padStart(2, "0");
                      const day = String(date.getDate()).padStart(2, "0");
                      return `${year}-${month}-${day}`;
                  }
                  document.getElementById("nameID").value = data.CPA_id || "";
                  document.getElementById("nameRCU").value = data.ST_rcu || "";
                  document.getElementById("namePCU").value = data.ST_pcu || "";
                  document.getElementById("nameCOMMODITY").value = data.ST_commodity || "";
                  document.getElementById("nameDIP").value = data.ST_nameofdip || "";
                  document.getElementById("nameFO").value = data.ST_nameof_fo || "";
                  document.getElementById("addressFO").value = data.ST_address_fo || "";
                  document.getElementById("af-msme").value = data.ST_af_msme || "";
                  document.getElementById("productType").value = data.ST_product_type || "";
                  document.getElementById("vs").value = data.ST_vol_supplied || "";
                  document.getElementById("aveP").value = data.ST_ave_price || "";
                  document.getElementById("totalTransaction").value = data.ST_total_transaction || "";
                  document.getElementById("incentives").value = data.ST_incentives_provided || "";
                  document.getElementById("date").value = formatDate(data.ST_date);
                  if (isView) {
                      const inputs = document.querySelectorAll(".TRACKING_FORM");
                      inputs.forEach((input) => {
                          input.disabled = true;
                          input.style.backgroundColor = "#e9ecef";
                      });
                      const submitButton = document.querySelector("button[type='button']");
                      const clearButton = document.querySelector("button[type='reset']");
                      if (submitButton) submitButton.disabled = true;
                      if (clearButton) clearButton.disabled = true;
                  }
                  if (isEdit) {
                      const submitButton = document.querySelector("button[type='button']");
                      if (submitButton) {
                          submitButton.textContent = "Update";
                          submitButton.onclick = function () {
                              updateSalesTracker(st_id);
                          };
                      }
                  }
              })
              .catch((error) => console.error("Error fetching data:", error));
      }
  });
  
  function updateSalesTracker(st_id) {
    const trackerInputs = document.querySelectorAll("#yearlySalesTrackerForm .TRACKING_FORM");
    let isValid = true;

    trackerInputs.forEach(input => {
        if (!input.value.trim()) {
            input.style.border = "2px solid red";
            isValid = false;
        } else {
            input.style.border = "2px solid #c2bfbf";
        }
    });

    if (!isValid) {
        Swal.fire({
            title: "Error!",
            text: "Please fill in all required fields before updating.",
            icon: "error",
            confirmButtonText: "OK"
        });
        return;
    }

    let formData = new FormData();
    trackerInputs.forEach(input => {
        formData.append(input.id, input.value);
    });

    fetch(`/update_sales_tracker/${st_id}`, {
        method: "POST",
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === "success") {
            // Fetch the CPA_id associated with the updated ST_id
            fetch(`/view-sales-tracker-table/${st_id}`)
                .then(response => response.json())
                .then(record => {
                    if (record && record.CPA_id) {
                        Swal.fire({
                            title: "Success!",
                            text: "Your record has been successfully updated.",
                            icon: "success",
                            confirmButtonText: "OK"
                        }).then(() => {
                            // Redirect to the table for the associated CPA_id
                            window.location.href = `/mis-v4/core-table-sales-tracker?tbl=dcf_implementing_unit&id=${record.CPA_id}`;
                        });
                    } else {
                        throw new Error("Failed to fetch CPA_id for redirection.");
                    }
                })
                .catch(error => {
                    console.error("Error fetching CPA_id:", error);
                    Swal.fire({
                        title: "Error!",
                        text: "Update successful, but redirection failed.",
                        icon: "error",
                        confirmButtonText: "OK"
                    });
                });
        } else {
            Swal.fire({
                title: "Error!",
                text: data.message,
                icon: "error",
                confirmButtonText: "OK"
            });
        }
    })
    .catch(error => {
        console.error("Error:", error);
        Swal.fire({
            title: "Error!",
            text: "Something went wrong. Please try again.",
            icon: "error",
            confirmButtonText: "OK"
        });
    });
}
  </script>