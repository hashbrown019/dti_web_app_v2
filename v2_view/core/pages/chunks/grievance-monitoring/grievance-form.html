<title>Grievance Redress System Form</title>
<div class="wrapper">
  <div id="content_griev">
      <h5 class="text-center" style="border: 2px solid #c2bfbf; padding: 10px; background-color: #4B5F71; color:#ffffff; padding: 10px;">Rapid Growth Project - Grievance Form</h5>
      <div class="text-center mb-4">
        <label>Alleged non-compliance with its social and environmental policies and mandatory aspects of its social, environmental and climate assessment procedures (SECAP)</label>
      </div>
      <br>

      <div class="container-fluid">
        <div class="card">
          <div class="card-body">
            <h5 id="complainant-info-title-2" class="text-center mb-4" style="border: 2px solid #c2bfbf; padding: 10px; background-color: #4B5F71; color:#ffffff; padding: 10px; margin-top: 15px;">I. Complainants' information</h5>
            <div class="row">
              <div class="col-md-6">
                <h5 class="text-center mb-4" style="border: 2px solid #c2bfbf; padding: 10px; background-color: #4B5F71; color:#ffffff; padding: 10px;">Complainant</h5>
                <div class="row">
                  <div class="col-md-6">
                    <label>Full Name</label>
                    <input id="complainant_1_fullname" type="text" class="GRIEVANCE_FORM form-control" placeholder="Enter Name" style="border: 2px solid #c2bfbf; padding: 10px; background-color: ghostwhite;" required>
                  </div>
                  <div class="col-md-6">
                  <label>Beneficiary Category</label>
                    <input list="complainant-1-beneficiary-category" id="complainant_1_beneficiary_category" class="GRIEVANCE_FORM form-control" style="border: 2px solid #c2bfbf; padding: 10px; background-color: ghostwhite;" placeholder="Type or select beneficiary category" required>
                    <datalist id="complainant-1-beneficiary-category">
                      <option value="Smallholder Farmer"></option>
                      <option value="MSME"></option>
                    </datalist>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <label>Organization</label>
                    <input id="complainant_1_organization" type="text" class="GRIEVANCE_FORM form-control" placeholder="Enter Organisation" style="border: 2px solid #c2bfbf; padding: 10px; background-color: ghostwhite;" required>
                 </div>
                  <div class="col-md-6">
                    <label>Contact Number</label>
                    <input id="complainant_1_phone" type="tel" class="GRIEVANCE_FORM form-control" placeholder="(0987) 654 3210" maxlength="11" style="border: 2px solid #c2bfbf; padding: 10px; background-color: ghostwhite;" required>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6">
                <label>Email</label>
                <input id="complainant_1_email" type="email" class="GRIEVANCE_FORM form-control" placeholder="Enter Email" style="border: 2px solid #c2bfbf; padding: 10px; background-color: ghostwhite;" required>
                </div>
                <div class="col-md-6">
                <label>DIP Name</label>
                <select class="GRIEVANCE_FORM form-control" id="complainant_1_dip_name" style="border: 2px solid #c2bfbf; padding: 10px; background-color: ghostwhite;" required>
                  <option value="">Choose your option</option>
                </select>
                </div>
                <div class="col-md-6">
                  <label>Gender</label>
                    <select id="complainant_1_gender" type="text" class="GRIEVANCE_FORM form-control" style="border: 2px solid #c2bfbf; padding: 10px; background-color: ghostwhite;" required>
                      <option value="" disabled selected>choose your option</option>
                      <option>Male</option>
                      <option>Female</option>
                  </select>
                  </div>
                  <div class="col-md-6">
                    <label>Age</label>
                    <input id="complainant_1_age" type="number" class="GRIEVANCE_FORM form-control" placeholder="Enter Age" style="border: 2px solid #c2bfbf; padding: 10px; background-color: ghostwhite;" required>
                </div>
                <div class="col-md-6">
                  <label>Sector</label>
                  <select id="complainant_1_sector" name="complainant_1_sector" class="GRIEVANCE_FORM form-control" style="border: 2px solid #c2bfbf; padding: 10px; background-color: ghostwhite;" required>
                    <option value="" disabled selected>Choose your option</option>
                    <option value="IP">IP</option>
                    <option value="NON IP">NON IP</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="col-md-6">
                <h5 id="location_title" class="text-center mb-4" style="border: 2px solid #c2bfbf; padding: 10px; background-color: #4B5F71; color:#ffffff; padding: 10px;">Location</h5>
                <label>Implementing Unit</label>
                  <input list="complainant-1-implementing-unit" id="complainant_1_implementing_unit" class="GRIEVANCE_FORM form-control" style="border: 2px solid #c2bfbf; padding: 10px; background-color: ghostwhite;" placeholder="Type or select implementing unit" required>
                  <datalist id="complainant-1-implementing-unit">
                    <option value="NPCO"></option>
                    <option value="R8"></option>
                    <option value="R9"></option>
                    <option value="R10"></option>
                    <option value="R11"></option>
                    <option value="R12"></option>
                    <option value="R13"></option>
                    <option value="BARMM"></option>
                  </datalist>
                <label>Your address/location</label>
                <input id="complainant_1_address" type="text" class="GRIEVANCE_FORM form-control" placeholder="Enter Address/Location" style="border: 2px solid #c2bfbf; padding: 10px; background-color: ghostwhite;" required>

                <label>Mailing Address (if different)</label>
                <input class="form-check-input" type="checkbox" id="same_as_address_checkbox" style="box-shadow: 0 0 2px 2px #4B5F71; margin-left: 1.5em;">
                <label class="form-check-label" for="same_as_address_checkbox" style="margin-left: 0.5em;">(check if same as above)</label>
                <input id="complainant_1_mailing_address" type="text" class="GRIEVANCE_FORM form-control" placeholder="Enter Mailing Address" style="border: 2px solid #c2bfbf; padding: 10px; background-color: ghostwhite;" required>

                <label>Additional guidance on how to locate you (if applicable)</label>
                <input id="complainant_1_additional_guidance" type="text" class="GRIEVANCE_FORM form-control" placeholder="Enter Additional Guidance" style="border: 2px solid #c2bfbf; padding: 10px; background-color: ghostwhite;">
              </div>
          </div>
        </div>
      </div>
      </div>

      <div class="container-fluid">
        <div class="card">
          <div class="card-body">
            <br>
            <h5 id="confidentiality_title" class="text-center mb-4" style="border: 2px solid #c2bfbf; padding: 10px; background-color: #4B5F71; color:#ffffff; padding: 10px;">II. Confidentiality</h5>
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label>a) Do you want your identity to be kept confidential?</label>
                    <select id="confidentiality_identity" class="GRIEVANCE_FORM form-control" style="border: 2px solid #c2bfbf; padding: 10px; background-color: ghostwhite;" required>
                      <option value="" disabled selected>choose your option</option>
                      <option>YES</option>
                      <option>NO</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div>
                  <label>b) If YES, please state why. If NO, please state your details below</label>
                  <input id="confidentiality_reason" name="confidentiality_reason" type="text" class="GRIEVANCE_FORM form-control" style="border: 2px solid #c2bfbf; padding: 10px; background-color: ghostwhite;" placeholder="Enter text" required>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <br>

    </head>
    <body>
      <div class="container-fluid">
        <div class="card">
          <div class="card-body">
            <h5 id="ifad_project_title" class="text-center mb-4" style="border: 2px solid #c2bfbf; padding: 10px; background-color: #4B5F71; color:#ffffff; padding: 10px; margin-top: 15px;">III. Details of the Complaint Raised</h5>
            <label>Date</label>
            <input id="complaint_raised_date" type="date" class="GRIEVANCE_FORM form-control mb-2" style="border: 2px solid #c2bfbf; padding: 10px; background-color: ghostwhite;" required>
            <label>a) Please provide a short description of your concerns about the project/programme.</label>
            <textarea id="project_concern_description" class="GRIEVANCE_FORM form-control mb-2" rows="3" placeholder="Enter text" style="border: 2px solid #c2bfbf; padding: 10px; background-color: ghostwhite;" required></textarea>
            <div class="col-md-12">
              <h5 id="staff_title" class="text-center mb-4" style="border: 2px solid #c2bfbf; padding: 10px; background-color: #4B5F71; color:#ffffff; margin-top: 15px;">
                Name of RAPID/DTI Staff who recorded the complaint
              </h5>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label>Name</label>
                  <input id="staff_name" type="text" class="GRIEVANCE_FORM form-control"
                        placeholder="Enter Name" style="border: 2px solid #c2bfbf; padding: 10px; background-color: ghostwhite;" required>
                </div>

                <div class="col-md-6 mb-3">
                  <label>Position</label>
                  <input id="staff_position" type="text" class="GRIEVANCE_FORM form-control"
                        placeholder="Enter Position" style="border: 2px solid #c2bfbf; padding: 10px; background-color: ghostwhite;" required>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label>Contact Number</label>
                  <input id="staff_contact" type="text" class="GRIEVANCE_FORM form-control"
                        placeholder="(0987) 654 3210" style="border: 2px solid #c2bfbf; padding: 10px; background-color: ghostwhite;" required>
                </div>

                <div class="col-md-6 mb-3">
                  <label>Implementing Unit</label>
                    <input list="staff_implementing_unit_list" id="staff_implementing_unit" class="GRIEVANCE_FORM form-control" style="border: 2px solid #c2bfbf; padding: 10px; background-color: ghostwhite;" placeholder="Type or select implementing unit" required>
                    <datalist id="staff_implementing_unit_list">
                      <option value="NPCO"></option>
                      <option value="R8"></option>
                      <option value="R9"></option>
                      <option value="R10"></option>
                      <option value="R11"></option>
                      <option value="R12"></option>
                      <option value="R13"></option>
                      <option value="BARMM"></option>
                    </datalist>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <br>
      <div class="container-fluid">
        <div class="card mb-4">
          <div class="card-body">
            <h5 id="grievance_status_title" class="text-center mb-4" style="border: 2px solid #c2bfbf; padding: 10px; background-color: #4B5F71; color:#ffffff; padding: 10px; margin-top: 15px;">IV. Delegated Office/Unit</h5>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="delegated_staff_name">Name Of Staff</label>
                <input id="delegated_staff_name" type="text" class="GRIEVANCE_FORM form-control"
                      style="border: 2px solid #c2bfbf; padding: 10px; background-color: ghostwhite;" placeholder="Enter Name of Staff" required>
              </div>
              <div class="col-md-6 mb-3">
                <label>Implementing Unit</label>
                    <input list="delegated_implementing_unit_list" id="delegated_implementing_unit" class="GRIEVANCE_FORM form-control" style="border: 2px solid #c2bfbf; padding: 10px; background-color: ghostwhite;" placeholder="Type or select implementing unit" required>
                    <datalist id="delegated_implementing_unit_list">
                      <option value="NPCO"></option>
                      <option value="R8"></option>
                      <option value="R9"></option>
                      <option value="R10"></option>
                      <option value="R11"></option>
                      <option value="R12"></option>
                      <option value="R13"></option>
                      <option value="BARMM"></option>
                    </datalist>
              </div>
            </div>

              <div class="row">
                <div class="col-md-12 mb-3">
                  <div class="row">
                    <div class="col-md-6">
                      <label>Results of Fact Finding</label>
                      <textarea id="fact_finding_results" class="GRIEVANCE_FORM form-control" placeholder="Enter Results of Fact Finding" rows="3" style="border: 2px solid #c2bfbf; padding: 10px; background-color: ghostwhite;"></textarea>
                    </div>
                    <div class="col-md-6">
                      <label>Appeals</label>
                      <textarea id="appeals" class="GRIEVANCE_FORM form-control" placeholder="Enter Appeals" rows="3" style="border: 2px solid #c2bfbf; padding: 10px; background-color: ghostwhite;"></textarea>
                    </div>
                  </div>
                </div>
              </div>
              <div class="row">
                  <div class="col-md-6 mb-3">
                    <label>Settlement</label>
                    <textarea id="settlement" class="GRIEVANCE_FORM form-control" placeholder="Enter Settlement" rows="3" style="border: 2px solid #c2bfbf; padding: 10px; background-color: ghostwhite;"></textarea>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label>Status</label>
                    <select id="grievance_status" name="grievance_status" class="GRIEVANCE_FORM form-control" style="border: 2px solid #c2bfbf; padding: 10px; background-color: ghostwhite;">
                      <option value="" disabled selected>Choose your option</option>
                      <option value="Closed/Resolved">Closed/Resolved</option>
                      <option value="Unable to Complete">Unable to Complete</option>
                      <option value="Forwarded to NPCO">Forwarded to NPCO</option>
                    </select>
                  </div>
                </div>
            <br>
          </div>
        </div>
      </div>
      <div class="text-center">
            <button type="submit" class="btn btn-primary" id="submit" style="border: 2px solid #c2bfbf; padding: 10px; width: 150px; font-size: 18px; font-weight: bold;" onclick="validateAndSubmit()">Submit</button>
      </div>
      <br>
  </div>
<div id="readonly" style="border: 2px solid #c2bfbf; padding: 10px; display: none;">{% if readonly %}true{% else %}false{% endif %}</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

<input type="hidden" id="created_by" class="GRIEVANCE_FORM" value="">

<script>
  // All JavaScript logic is consolidated here for better organization and readability.

  // Helper function to toggle visibility and required status of an input field
  function toggleOtherImplementingUnit(selectElement, otherInputId) {
    const otherInput = document.getElementById(otherInputId);
    if (selectElement.value === 'OTHER') {
      otherInput.style.display = '';
      otherInput.required = true;
    } else {
      otherInput.style.display = 'none';
      otherInput.required = false;
      otherInput.value = '';
    }
  }

  // Function to populate form fields with data fetched from the backend
  function populateFields(data) {
    const formElements = document.querySelectorAll('.GRIEVANCE_FORM');

    formElements.forEach(element => {
        const id = element.id;
        const name = element.name;
        const type = element.type;

        // Determine the key to look for in the data object
        let valueToSet = data[id];
        if (type === 'radio') {
            valueToSet = data[name];
        }

        if (valueToSet !== undefined) {
            if (type === 'radio') {
                if (element.value === valueToSet) {
                    element.checked = true;
                }
            } else if (type === 'date') {
                // Format date string to 'YYYY-MM-DD' for date input
                const date = new Date(valueToSet);
                element.value = date.toISOString().split('T')[0];
            } else {
                element.value = valueToSet; // Handles text, select, datalist-linked inputs
            }
        }
    });
  }

  // Function to disable all form inputs for view mode
  function disableForm() {
    const inputs = document.querySelectorAll('.GRIEVANCE_FORM');
    inputs.forEach(input => {
        input.setAttribute('readonly', true);
        input.style.backgroundColor = "#d3d3d3";
        input.style.cursor = "not-allowed";
    });
    const selects = document.querySelectorAll('select.GRIEVANCE_FORM');
    selects.forEach(select => {
        select.setAttribute('disabled', true);
        select.style.cursor = "not-allowed";
    });
    // Disable specific buttons if they exist (e.g., addRowBtn2, deleteBtn, viewTableBtn)
    const addRowButtons = [document.getElementById('addRowBtn2')];
    addRowButtons.forEach(button => {
        if (button) {
            button.setAttribute('disabled', true);
            button.style.cursor = "not-allowed";
            button.style.backgroundColor = "#d3d3d3";
        }
    });
    const deleteButtons = document.querySelectorAll('.deleteBtn');
    deleteButtons.forEach(button => {
        button.setAttribute('disabled', true);
        button.style.cursor = "not-allowed";
        button.style.backgroundColor = "#ff9b9b";
    });

    const viewTableBtn = document.getElementById('viewTableBtn');
    if (viewTableBtn) {
        viewTableBtn.setAttribute('disabled', true);
        viewTableBtn.style.cursor = "not-allowed";
        viewTableBtn.style.backgroundColor = "#d3d3d3";
    }
  }

  // Function to enable form inputs for edit mode
  function enableForm(id) {
    const inputs = document.querySelectorAll('.GRIEVANCE_FORM');
    inputs.forEach(input => {
      input.removeAttribute('readonly');
      input.style.backgroundColor = "ghostwhite"; // Revert to original background
      input.style.cursor = "auto";
    });
    const selects = document.querySelectorAll('select.GRIEVANCE_FORM');
    selects.forEach(select => {
      select.removeAttribute('disabled');
      select.style.cursor = "auto";
    });
    // Enable specific buttons if they exist
    const addRowButtons = [document.getElementById('addRowBtn2')];
    addRowButtons.forEach(button => {
        if (button) {
            button.removeAttribute('disabled');
            button.style.cursor = "pointer";
            button.style.backgroundColor = "";
        }
    });
    const deleteButtons = document.querySelectorAll('.deleteBtn');
    deleteButtons.forEach(button => {
        button.removeAttribute('disabled');
        button.style.cursor = "pointer";
        button.style.backgroundColor = "";
    });
  }

  // Function to collect form data and send it to the backend for submission
  function submit_grievance() {
    const grievance_form_fields = {};
    const formElements = document.querySelectorAll('.GRIEVANCE_FORM');

    formElements.forEach(element => {
        const id = element.id;
        const name = element.name;
        const type = element.type;
        // Use name attribute for radio buttons, otherwise use id
        let key = name || id;
        if (type === 'radio') {
            if (element.checked) {
                grievance_form_fields[key] = element.value.trim();
            }
        } else {
            grievance_form_fields[key] = element.value.trim();
        }
    });

    // Send data using the custom $send function
    $send({
        action: "/insert/grievance",
        data: $DATA(grievance_form_fields),
        method: POST, // Assuming POST is a global constant or defined elsewhere
    });
  }

  // Function to validate all required fields and submit the form
  function validateAndSubmit() {
      const requiredInputs = document.querySelectorAll('input[required], select[required], textarea[required]');
      let isValid = true;
      requiredInputs.forEach(function(input) {
          // For radio buttons, check if at least one in the group is checked
          if (input.type === 'radio') {
              const radioGroup = document.querySelectorAll(`input[name="${input.name}"]`);
              const isRadioGroupChecked = Array.from(radioGroup).some(radio => radio.checked);
              if (!isRadioGroupChecked) {
                  isValid = false;
                  // Highlight the first radio in the group for visual feedback
                  radioGroup[0].style.setProperty('outline', '1px solid red');
              } else {
                  radioGroup.forEach(radio => radio.style.setProperty('outline', ''));
              }
          } else if (!input.value.trim()) {
              isValid = false;
              input.style.setProperty('border', '1px solid red');
          } else {
              input.style.setProperty('border', '');
          }
      });

      if (isValid) {
          submit_grievance();
          Swal.fire({
              position: "center",
              icon: "success",
              title: "Successfully submitted",
              showConfirmButton: false,
              timer: 1500
          }).then(() => {
              Swal.fire({
                  title: "Processing...",
                  text: "Please wait while we redirect you to Dashboard.",
                  allowOutsideClick: false,
                  allowEscapeKey: false,
                  didOpen: () => {
                      Swal.showLoading();
                  }
              });
              window.location.href = "/grievance-table";
          });
      } else {
          Swal.fire({
              position: "center",
              icon: "error",
              title: "Please fill all required fields",
              showConfirmButton: false,
              timer: 1500
          });
      }
  }

  // Function to validate fields and update grievance data
  function validateAndUpdate(id) {
    const requiredInputs = document.querySelectorAll('input[required], select[required], textarea[required]');
    let isValid = true;
    requiredInputs.forEach(function (input) {
        // Validation logic for radio buttons and other inputs
        if (input.type === 'radio') {
            const radioGroup = document.querySelectorAll(`input[name="${input.name}"]`);
            const isRadioGroupChecked = Array.from(radioGroup).some(radio => radio.checked);
            if (!isRadioGroupChecked) {
                isValid = false;
                radioGroup[0].style.setProperty('outline', '1px solid red');
            } else {
                radioGroup.forEach(radio => radio.style.setProperty('outline', ''));
            }
        } else if (!input.value.trim()) {
            isValid = false;
            input.style.setProperty('border', '1px solid red');
        } else {
            input.style.setProperty('border', '');
        }
    });

    if (isValid) {
        const grievance_form_fields = {};
        const formElements = document.querySelectorAll('.GRIEVANCE_FORM');

        formElements.forEach(element => {
            const elementId = element.id;
            const name = element.name;
            const type = element.type;

            if (type === 'radio') {
                if (element.checked) {
                    grievance_form_fields[name] = element.value.trim();
                }
            } else {
                grievance_form_fields[elementId] = element.value.trim();
            }
        });

        console.log("Grievance Form Fields for Update:", grievance_form_fields);

        fetch(`/update_grievance_data/${id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(grievance_form_fields)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                Swal.fire({
                    position: "center",
                    icon: "success",
                    title: "Updated successfully",
                    showConfirmButton: false,
                    timer: 1500
                }).then(() => {
                    Swal.fire({
                        title: "Processing...",
                        text: "Please wait while we redirect you to Dashboard.",
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    window.location.href = "/grievance-table";
                });
            } else {
                Swal.fire({
                    position: "center",
                    icon: "error",
                    title: "Failed to update the record",
                    text: data.message,
                    showConfirmButton: true
                });
            }
        })
        .catch(error => {
            Swal.fire({
                position: "center",
                icon: "error",
                title: "An error occurred",
                text: error.message,
                showConfirmButton: true
            });
        });
    } else {
        Swal.fire({
            position: "center",
            icon: "error",
            title: "Please fill all required fields",
            showConfirmButton: false,
            timer: 1500
        });
    }
  }

  // Populates the 'DIP Name' select dropdown by fetching data from an API
  async function populateDipNames() {
    try {
      const response = await fetch('/api/get_dip_names');
      if (!response.ok) {
        const text = await response.text();
        throw new Error(`HTTP error! status: ${response.status}, message: ${text}`);
      }
      const data = await response.json();
      const selectElement = document.getElementById('complainant_1_dip_name');
      if (selectElement) {
          // Clear existing options to prevent duplication
          selectElement.innerHTML = '<option value="">Choose your option</option>';
          data.forEach(item => {
            const option = document.createElement('option');
            option.value = item.form_1_name_dip;
            option.textContent = item.form_1_name_dip;
            selectElement.appendChild(option);
          });
      }
    } catch (error) {
      console.error('Error fetching DIP names:', error);
    }
  }

  // Main DOMContentLoaded listener to initialize the form
  document.addEventListener("DOMContentLoaded", async function () {
    await populateDipNames();

    const urlParams = new URLSearchParams(window.location.search);
    const recordId = urlParams.get('view');
    const editId = urlParams.get('edit');
    const submitButton = document.getElementById('submit');
    const clearButton = document.getElementById('clear'); // If you have a clear/reset button

    // Helper to disable all form fields
    function setFormDisabled(disabled) {
        const formElements = document.querySelectorAll('.GRIEVANCE_FORM');
        formElements.forEach(el => {
            if (el.tagName === "SELECT" || el.tagName === "INPUT" || el.tagName === "TEXTAREA") {
                el.disabled = disabled;
                el.style.backgroundColor = disabled ? "#e9ecef" : "ghostwhite";
            }
        });
        const sameAsCheckbox = document.getElementById('same_as_address_checkbox');
        if (sameAsCheckbox) {
            sameAsCheckbox.disabled = disabled;
            sameAsCheckbox.style.cursor = disabled ? "not-allowed" : "pointer";
        }
    }

    // Always disable by default
    setFormDisabled(false);
    if (submitButton) submitButton.disabled = false;
    if (clearButton) clearButton.disabled = false;

    // Get session user
    let loggedInUserId = null;
    try {
        const sessionRes = await fetch("/mis-v4/get-session");
        const sessionData = await sessionRes.json();
        if (sessionData && sessionData[0] && sessionData[0].id) {
            loggedInUserId = Number(sessionData[0].id);
            const createdByField = document.getElementById("created_by");
            if (createdByField) createdByField.value = loggedInUserId;
        }
    } catch (e) {
        console.error("Error fetching session:", e);
    }

    // View mode
    if (recordId) {
        try {
            const response = await fetch(`/get_grievance_data?id=${recordId}`);
            const data = await response.json();
                if (data.status === "error") {
                    console.error(data.message);
                    return;
                }
                const record = data[0];
                populateFields(record);
                setFormDisabled(true);
                if (submitButton) submitButton.disabled = true;
            if (clearButton) clearButton.disabled = true;
        } catch (error) {
            console.error("Error fetching data for view mode:", error);
        }
    }

    // Edit mode
    if (editId) {
        try {
            const response = await fetch(`/get_grievance_data?id=${editId}`);
            const data = await response.json();
                if (data.status === "error") {
                    console.error(data.message);
                    return;
                }
                const record = data[0];
                populateFields(record);

            // Only allow edit if user is creator
            let canEdit = false;
            if (loggedInUserId && loggedInUserId == record.created_by) {
                canEdit = true;
            }

                if (canEdit) {
                    setFormDisabled(false);
                    if (submitButton) {
                        submitButton.textContent = "Update";
                        submitButton.disabled = false;
                        submitButton.onclick = function () {
                            validateAndUpdate(editId);
                        };
                    }
                if (clearButton) clearButton.disabled = false;
                } else {
                    setFormDisabled(true);
                    if (submitButton) {
                        submitButton.textContent = "Update";
                        submitButton.disabled = true;
                    }
                if (clearButton) clearButton.disabled = true;
                }
        } catch (error) {
            console.error("Error fetching data for edit mode:", error);
        }
    }
});

  // SweetAlert2 fix for back/forward navigation, ensuring modals are closed
  window.addEventListener("pageshow", function(event) {
      if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
        Swal.close();
      }
  });
</script>
<script>
  // Checkbox logic for copying address to mailing address
  document.addEventListener('DOMContentLoaded', function () {
    const addressInput = document.getElementById('complainant_1_address');
    const mailingInput = document.getElementById('complainant_1_mailing_address');
    const checkbox = document.getElementById('same_as_address_checkbox');

    function syncMailingAddress() {
      if (checkbox.checked) {
        mailingInput.value = addressInput.value;
        mailingInput.setAttribute('readonly', true);
        mailingInput.style.backgroundColor = "#e9ecef";
      } else {
        mailingInput.removeAttribute('readonly');
        mailingInput.style.backgroundColor = "ghostwhite";
      }
    }

    checkbox.addEventListener('change', syncMailingAddress);
    addressInput.addEventListener('input', function () {
      if (checkbox.checked) {
        mailingInput.value = addressInput.value;
      }
    });
  });
</script>