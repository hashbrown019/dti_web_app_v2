    <div class="container-fluid table-wrapper">
        <div class="card shadow">
            <div class="card-header text-white text-center" style="background-color: #096272;">
                <h4 class="mb-0">Narrative Progress Report Table</h4>
            </div>
            <div class="card-body table-responsive">
                <table id="progressTable" class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <th style="width: 20%;">Key Indicators</th>
                            <th style="width: 4%;">No.</th>
                            <th style="width: 20%;">Performance Indicators</th>
                            <th style="width: 5%;">Targets</th>
                            <th>Jan</th>
                            <th>Feb</th>
                            <th>Mar</th>
                            <th>Apr</th>
                            <th>May</th>
                            <th>Jun</th>
                            <th>Jul</th>
                            <th>Aug</th>
                            <th>Sep</th>
                            <th>Oct</th>
                            <th>Nov</th>
                            <th>Dec</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Table content will be generated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        const tableData = [
            {
                component: "COMPONENT 1: DIRECT ASSISTANCE TO ENTERPRISE",
                subcomponents: [
                    {
                        name: "Sub component 1.1 Business Services",
                        indicators: [
                            {
                                name: "1.1.1 Business Development Services",
                                performanceIndicators: [
                                    "1.1.1.1 Number of qualified BDS providers engaged"
                                ]
                            },
                            {
                                name: "1.1.2 Profiling",
                                performanceIndicators: [
                                    "1.1.2.1 Number of Smallholder Farmer Households Profiled",
                                    "1.1.2.2 Number of FOs profiled",
                                    "1.1.2.3 Number of MSMEs profiled"
                                ]
                            },
                            {
                                name: "1.1.3 Capacity Building",
                                performanceIndicators: [
                                    "1.1.3.1 Number of capacity building activities conducted",
                                    "1.1.3.2 Number of participants"
                                ]
                            },
                            {
                                name: "1.1.4 Product Development Assistance/ Consultancy Services",
                                performanceIndicators: [
                                    "1.1.4.1 Number of product development assistance provided",
                                    "1.1.4.2 Number of products/systems (e.g. digital processes) developed /improved",
                                    "1.1.4.3 Number of firm level productivity and quality standards consultancy services provided"
                                ]
                            },
                            {
                                name: "1.1.5 Marketing Assistance",
                                performanceIndicators: [
                                    "1.1.5.1 Number of trade promotions activities organized/participated",
                                    "1.1.5.2 Number of MSMEs/FOs/farmers assisted",
                                    "1.1.5.3 Number of firms/MSMEs/FOs that have received quality and trade-related certifications",
                                    "1.1.5.4 Number of products certified"
                                ]
                            }
                        ]
                    },
                    {
                        name: "Sub component 1.2 Enterprise Strengthening",
                        indicators: [
                            {
                                name: "1.2.1 Investment Plan Preparation",
                                performanceIndicators: [
                                    "1.2.1.1 Number of approved DIPs"
                                ]
                            },
                            {
                                name: "1.2.2 Productive Investments Facilitation",
                                performanceIndicators: [
                                    "1.2.2.2 Number of MGRRs approved",
                                    "1.2.2.3 Number of MG funds (MGRRs) support received by FOs and MSMEs",
                                    "1.2.2.4 Number of Smallholder Farmers received the MG inputs/tools",
                                    "1.2.2.5 Number of Firms, FOs/MSMEs received MG Assistance (expansion, rehab,productive investments) through matching grants",
                                    "1.2.2.6 Number of farms rehabilitated (In Number of hectares)",
                                    "1.2.2.7 Number of expansion areas (in Number of hectares)"
                                ]
                            }
                        ]
                    },
                    {
                        name: "Sub component 1.3 Farm To Market Infrastructure",
                        indicators: [
                            {
                                name: "1.3.1 FMI Technical Support",
                                performanceIndicators: [
                                    "1.3.1.1 length of road rehabilitated (in km)"
                                ]
                            }
                        ]
                    }
                ]
            },
            {
                component: "COMPONENT 2: INSTITUTIONAL STRENGTHENING",
                subcomponents: [
                    {
                        name: "Sub component 2.1 Value Chain Governance",
                        indicators: [
                            {
                                name: "2.1.1 Partnership Agreements",
                                performanceIndicators: [
                                    "2.1.1.1 Number of commercial partnership agreements supported by DIPs"
                                ]
                            },
                            {
                                name: "2.1.2 Industry Studies",
                                performanceIndicators: [
                                    "2.1.2.1 Number of Industry Studies Prepared"
                                ]
                            },
                            {
                                name: "2.1.3 Industry Council & Stakeholders Engagement/Partnerships (MOAs)",
                                performanceIndicators: [
                                    "2.1.3.1 Number of RAPID assisted/ participated/ sponsored industry-organized congress/ conferences, events and meetings, and capbuild activities",
                                    "2.1.3.2 Number of resolutions/Policy Recoms passed by RTWGs"
                                ]
                            }
                        ]
                    }
                ]
            },
            {
                component: "COMPONENT 3: TECHNICAL ASSISTANCE TO FSPs",
                subcomponents: [
                    {
                        name: "3.1 Financing Campaigns and Promotions",
                        indicators: [
                            {
                                name: "3.1 Financing Campaigns and Promotions",
                                performanceIndicators: [
                                    "3.1.1.1 Number of MSMEs availed of Financial Services",
                                    "3.1.1.2 Number of FOs availed Financial Service",
                                    "3.1.1.3 Number of Farming Households availed Financial Services",
                                    "3.1.1.4 Number of FSPs extend suitable VC Financial Services",
                                    "3.1.1.5 Number of Suitable Financial Products Developed",
                                    "3.1.1.6 Number of Financing related activities conducted  or facilitated",
                                    "3.1.1.7 Number of FOs Linked to Financial Services",
                                    "3.1.1.8 Number of MSMEs Linked to Financial Services"
                                ]
                            }
                        ]
                    }
                ]
            },
            {
                component: "COMPONENT 4: INNOVATIVE FINANCING",
                subcomponents: [
                    {
                        name: "4.1 Financing Campaigns and Promotions",
                        indicators: [
                            {
                                name: "4.1 Financing Campaigns and Promotions",
                                performanceIndicators: [
                                    "4.1.1.1 Number of Firms availed of Financing Services through SBC's equity financing",
                                    "4.1.1.2 Number of Info Campaigns/Orientation/ Conducted by SBC and other technical assistance-related activities"
                                ]
                            }
                        ]
                    }
                ]
            },
            {
                component: "COMPONENT 5: PROJECT MANAGEMENT",
                subcomponents: [
                    {
                        name: "Sub component 5.1: Establishment of project management structures & systems",
                        indicators: [
                            {
                                name: "5.1.1 Staff support and Systems",
                                performanceIndicators: [
                                    "5.1.1.1 Number of Project Staff Hired",
                                    "5.1.1.2 Number of plans, policies/guidelines, and manuals prepared/ updated"
                                ]
                            }
                        ]
                    },
                    {
                        name: "Sub component 5.2: Staff Training and Capacity Building",
                        indicators: [
                            {
                                name: "5.2.1 Capacity-Building of Project Implementers",
                                performanceIndicators: [
                                    "5.2.1.1 Number of Capacity Building/enhancement initiatives provided for RAPID staff, DTI organic staff, and Negosyo Center Business Counselors",
                                    "5.2.1.2 Number of project staff participated on capacity building activities"
                                ]
                            }
                        ]
                    },
                    {
                        name: "Sub component 5.3: Project Coordination and Networking",
                        indicators: [
                            {
                                name: "5.3.1 Project Coordination and Networking",
                                performanceIndicators: [
                                    "5.3.1.1 Number of Coordination meeting conducted",
                                    "5.3.1.2 Number of Program Networking Activities participated",
                                    "5.3.1.3 Number of RTWGs organized and maintained"
                                ]
                            }
                        ]
                    },
                    {
                        name: "Sub component 5.4: Results Based Project Monitoring and Evaluation",
                        indicators: [
                            {
                                name: "5.4.1 Monitoring and Evaluation",
                                performanceIndicators: [
                                    "5.4.1.1 MIS established and updated",
                                    "5.4.1.2 Number of M&E Activities initated/facilitated",
                                    "5.4.1.3 Number of Reports Submitted"
                                ]
                            },
                            {
                                name: "5.4.2 Communication and Knowledge Management",
                                performanceIndicators: [
                                    "5.4.2.4 Number of KM materials prepared, updated, and disseminated"
                                ]
                            }
                        ]
                    },
                    {
                        name: "Sub component 5.5: GESI",
                        indicators: [
                            {
                                name: "5.5.1 GESI",
                                performanceIndicators: [
                                    "5.5.1.1 Number of GESI and SECAP activities/projects initiated/coordinated",
                                    "5.5.1.2 Number of participants"
                                ]
                            }
                        ]
                    },
                    {
                        name: "Sub component 5.6 Financial Performance Monitoring",
                        indicators: [
                            {
                                name: "5.6.1 Financial Performance Monitoring",
                                performanceIndicators: [
                                    "5.6.1.1 Number of Regional SOE Submitted"
                                ]
                            }
                        ]
                    }
                ]
            }
        ];

// List of months in order
const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

// Converts full month names to short versions
const monthMap = {
    January: "Jan", February: "Feb", March: "Mar", April: "Apr",
    May: "May", June: "Jun", July: "Jul", August: "Aug",
    September: "Sep", October: "Oct", November: "Nov", December: "Dec",
    Jan: "Jan", Feb: "Feb", Mar: "Mar", Apr: "Apr",
    Jun: "Jun", Jul: "Jul", Aug: "Aug", Sep: "Sep", Oct: "Oct", Nov: "Nov", Dec: "Dec"
};

// Main data storage
let indicatorMap = {};
let specialActivities = {}; // stores rows for participant calculation

// ✅ One entry = One count indicators
const oneEntryIndicators = [
    "1.1.3.1 Number of capacity building activities conducted",
    "1.1.5.1 Number of trade promotions activities organized/participated",
    "3.1.1.6 Number of Financing related activities conducted  or facilitated",
    "4.1.1.2 Number of Info Campaigns/Orientation/ Conducted by SBC and other technical assistance-related activities",
    "5.2.1.1 Number of Capacity Building/enhancement initiatives provided for RAPID staff, DTI organic staff, and Negosyo Center Business Counselors",
    "5.3.1.1 Number of Coordination meeting conducted",
    "5.3.1.2 Number of Program Networking Activities participated",
    "5.5.1.1 Number of GESI and SECAP activities/projects initiated/coordinated"
];

// ✅ Activity ↔ Participants (Male+Female) indicators
const activityParticipantPairs = [
    {
        activity: "1.1.2.1 Number of Smallholder Farmer Households Profiled",
        participant: null // itself uses male+female formula directly
    },
    {
        activity: "1.1.3.1 Number of capacity building activities conducted",
        participant: "1.1.3.2 Number of participants"
    },
    {
        activity: "5.2.1.1 Number of Capacity Building/enhancement initiatives provided for RAPID staff, DTI organic staff, and Negosyo Center Business Counselors",
        participant: "5.2.1.2 Number of project staff participated on capacity building activities"
    },
    {
        activity: "5.5.1.1 Number of GESI and SECAP activities/projects initiated/coordinated",
        participant: "5.5.1.2 Number of participants"
    },
    {
        activity: "1.1.5.1 Number of trade promotions activities organized/participated",
        participant: "1.1.5.2 Number of MSMEs/FOs/farmers assisted"
    },
];

// Initialize specialActivities storage
oneEntryIndicators.forEach(ind => specialActivities[ind] = {});
activityParticipantPairs.forEach(pair => {
    if (pair.activity && !specialActivities[pair.activity]) {
        specialActivities[pair.activity] = {};
    }
    if (pair.activity === "1.1.2.1 Number of Smallholder Farmer Households Profiled") {
        specialActivities[pair.activity] = {}; // needed for direct male+female
    }
});

// Fetch and process data
async function fetchProgressReportData() {
    try {
        const response = await fetch('/get_progress_report_data');
        const data = await response.json();

        indicatorMap = {};
        for (let key in specialActivities) specialActivities[key] = {}; // reset

        data.forEach(row => processRow(row));
        computeParticipants();
        generateTable();
    } catch (err) {
        console.error("Failed to fetch data:", err);
        document.getElementById('tableBody').innerHTML =
            '<tr><td colspan="17" class="text-center text-danger">Failed to load data.</td></tr>';
    }
}

// Process each row from database
function processRow(row) {
    const indicator = row.awpb_indicators;
    const month = monthMap[row.activity_month] || row.activity_month;
    const value = parseFloat(row.awpb_accomplishments) || 0;

    if (!indicatorMap[indicator]) indicatorMap[indicator] = {};
    if (!indicatorMap[indicator][month]) indicatorMap[indicator][month] = 0;

    // ✅ 1. One-entry-count indicators
    if (oneEntryIndicators.includes(indicator)) {
        indicatorMap[indicator][month] += 1;
        if (!specialActivities[indicator][month]) specialActivities[indicator][month] = [];
        specialActivities[indicator][month].push(row);
    }
    // ✅ 2. Skip participant indicators for now (computed later)
    else if (activityParticipantPairs.some(p => p.participant === indicator)) {
        return;
    }
    // ✅ 3. Direct Male+Female indicators
    else if (
        indicator === "1.1.2.1 Number of Smallholder Farmer Households Profiled" ||
        indicator === "3.1.1.3 Number of Farming Households availed Financial Services"
    ) {
        indicatorMap[indicator][month] +=
            (parseFloat(row.male_participants) || 0) +
            (parseFloat(row.female_participants) || 0);
    }
    // ✅ 4. Normal numeric indicators
    else {
        indicatorMap[indicator][month] += value;
    }
}

// Compute participants (Male+Female) from stored specialActivities
function computeParticipants() {
    activityParticipantPairs.forEach(pair => {
        if (!pair.participant) return; // skip if no participant indicator
        indicatorMap[pair.participant] = {};
        months.forEach(month => {
            const rows = specialActivities[pair.activity][month] || [];
            const totalParticipants = rows.reduce((sum, r) =>
                sum + (parseFloat(r.male_participants) || 0) +
                      (parseFloat(r.female_participants) || 0), 0);
            indicatorMap[pair.participant][month] = totalParticipants;
        });
    });
}

// Table rendering (unchanged)
function generateTable() {
    const tableBody = document.getElementById('tableBody');
    tableBody.innerHTML = '';

    tableData.forEach(component => {
        tableBody.appendChild(createFullWidthRow(component.component, 'component-row'));

        component.subcomponents.forEach(subcomponent => {
            tableBody.appendChild(createFullWidthRow(subcomponent.name, 'subcomponent-row'));

            subcomponent.indicators.forEach(indicator => {
                const indicatorRow = createIndicatorRow(indicator.performanceIndicators[0], indicator.name);
                tableBody.appendChild(indicatorRow);

                for (let i = 1; i < indicator.performanceIndicators.length; i++) {
                    tableBody.appendChild(createIndicatorRow(indicator.performanceIndicators[i]));
                }
            });
        });
    });
}

function createIndicatorRow(indicatorText, keyIndicatorName = '') {
    const row = document.createElement('tr');
    row.className = keyIndicatorName ? 'indicator-with-perf-row' : 'performance-indicator-row';

    const number = indicatorText.split(' ')[0];
    const text = indicatorText.substring(indicatorText.indexOf(' ') + 1);

    row.appendChild(createCell(keyIndicatorName));
    row.appendChild(createCell(number));
    row.appendChild(createCell(text));
    appendDataCells(row, indicatorText);

    return row;
}

function appendDataCells(row, indicatorName) {
    row.appendChild(createCell('')); // empty targets
    let total = 0;
    months.forEach(month => {
        const val = indicatorMap[indicatorName]?.[month] || 0;
        total += val;
        row.appendChild(createCell(val > 0 ? val : ''));
    });
    row.appendChild(createCell(total > 0 ? total : ''));
}

function createCell(text, className = '') {
    const cell = document.createElement('td');
    cell.textContent = text;
    if (className) cell.className = className;
    return cell;
}

function createFullWidthRow(text, rowClass) {
    const row = document.createElement('tr');
    row.className = rowClass;
    const cell = document.createElement('td');
    cell.textContent = text;
    cell.colSpan = 17;
    row.appendChild(cell);
    return row;
}

window.onload = fetchProgressReportData;
</script>