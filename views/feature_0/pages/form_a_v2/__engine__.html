<script type="text/javascript">
	// ===== Fetch record and open modal =====
	function get_record_data_farmer(RECORD_PROFILE_ID, REFNUM) {
		var _table = ["excel_import_form_a"]; 
		println(" === Loading Profile");
		$send({
			action: "/form_a/get_ind_data_val",
			method: POST,
			data: $DATA({ "tables": _table, "record_id": RECORD_PROFILE_ID }),
			err_dialog: true,
			func: function (r) {
				var res = JSON.parse(r);
				println(res);
				println("OPENING FORM A DATA");
				fill_data_inp_f_a(res['data']);
			}
		});
	}

	// called from table row
	function form_a_forms(RECORD_PROFILE_ID, REFNUM) {
		get_record_data_farmer(RECORD_PROFILE_ID, REFNUM);
	}

	// ======= Fill modal data =======
	function fill_data_inp_f_a(data_){
		modeal_basic_info(data_);
		DICT_TO_INPUT(data_[0][0], 'FORM_DATA_A');
	}

	// ======= Profile panel =======
	var profile_panel_basic;
	var full_details = undefined;
	const CURRENT_USER_ID = {{ session["USER_DATA"][0]["id"]|tojson }};

	function modeal_basic_info(full_details_) {
		full_details = full_details_[0][0];
		profile_panel_basic = $dialog({
			title: "Basic Information",
			subtitle: " ",
			content: (`
				<div class="x-row">
					<div class="x-container x-col l6 m6 s6">
						<img src="../static/img/male.png" style="width:100%">
					</div>
					<div class="x-container x-col l6 m6 s6">
						<span>
							<span class="x-text-grey">Name:<br></span> 
							<b class="x-xlarge">
								<span>${full_details["frmer_prof_@_basic_Info_@_First_name"]}</span> 
								<span>${full_details["frmer_prof_@_basic_Info_@_Middle_name"]}</span> 
								<span>${full_details["frmer_prof_@_basic_Info_@_Last_name"]}</span>, 
								<span>${full_details["frmer_prof_@_basic_Info_@_Extension_name"]}</span>
							</b><br><br>
						</span>

						<span>
							<span class="x-text-grey">Address:<br></span> 
							<b class="x-xlarge"> 
								<span>Region ${full_details["frmer_prof_@_frmer_addr_@_region"]}</span>, 
								<span>${full_details["frmer_prof_@_frmer_addr_@_province"]}</span>, 
								<span>${full_details["frmer_prof_@_frmer_addr_@_city_municipality"]}</span>
							</b><br><br>
						</span>

						<span>
							<span class="x-text-grey">Commodity:<br></span> 
							<b class="x-xlarge">${full_details["frmer_prof_@_Farming_Basic_Info_@_primary_crop"]}</b><br><br>
						</span>

						<br><br>
						<span>
							<span class="x-text-grey">More Actions:<br></span> 
							<button class="x-large x-text-blue x-chip" 
								onclick="see_full_details()" 
								style="cursor:pointer; background:none; border:none; padding:0;">
								Edit This Profile
							</button>

							<button class="x-large x-text-red x-chip" 
								onclick="delete_this_profile('${full_details["id"]}')" 
								style="cursor:pointer; background:none; border:none; padding:0; margin-left:10px;">
								Delete This Profile
							</button>
							<br><br>
						</span>
					</div>
				</div>
			`)
		});
		profile_panel_basic.show();
	}

	// ======= Delete function =======
	function delete_this_profile(profileId) {
		if (!profileId) {
			Swal.fire({
				icon: 'error',
				title: 'Missing ID',
				text: 'Profile ID missing!',
			});
			return;
		}
	
		Swal.fire({
			title: 'Are you sure?',
			text: "This will permanently delete this profile.",
			icon: 'warning',
			showCancelButton: true,
			confirmButtonColor: '#d33',
			cancelButtonColor: '#3085d6',
			confirmButtonText: 'Yes, delete it!'
		}).then((result) => {
			if (result.isConfirmed) {
				$send({
					action: "/form_a/del_profile",
					method: POST,
					data: $DATA({ id: profileId }),
					func: function (res) {
						if (profile_panel_basic) profile_panel_basic.destroy();
						DUPLICATE_DATA.forEach((group, gIndex) => {
							DUPLICATE_DATA[gIndex] = group.filter(r => String(r.db_id) !== String(profileId));
						});
						DUPLICATE_DATA = DUPLICATE_DATA.filter(g => g.length > 0);
						render_duplicates_page(CURRENT_PAGE, CURRENT_SEARCH);
						Swal.fire({
							icon: 'success',
							title: 'Deleted!',
							text: 'Profile has been deleted.',
							timer: 1500,
							showConfirmButton: false
						});
					},
					err_dialog: true
				});
			}
		});
	}

	// ======= See full details with proper checks =======
	function see_full_details() {
		if (profile_panel_basic) profile_panel_basic.destroy();                 
		document.querySelectorAll('.page_content').forEach(div => div.style.display = 'none');
		document.getElementById('forms').style.display = 'block';
		setTimeout(() => {
			lockFieldsIfYouth();

			if (full_details && CURRENT_USER_ID) {
				const recordOwnerId = String(full_details["user_id"]); 
				if (recordOwnerId !== String(CURRENT_USER_ID)) {
					disableForm();
				} else {
					enableForm();
				}
			}
		}, 200);
	}

	// ======= Youth lock =======
	function excelSerialToDate(serial) {
		const excelEpoch = new Date(1899, 11, 30);
		return new Date(excelEpoch.getTime() + Math.floor(serial) * 24 * 60 * 60 * 1000);
	}

	function getAgeFromBirthday(birthdayValue) {
		if (!birthdayValue) return null;
		let birthDate = null;
		if (typeof birthdayValue === 'number') {
			birthDate = excelSerialToDate(birthdayValue);
		} else if (!isNaN(birthdayValue)) {
			birthDate = excelSerialToDate(parseFloat(birthdayValue));
		} else {
			birthDate = new Date(birthdayValue);
		}
		if (isNaN(birthDate)) return null;
		const today = new Date();
		let age = today.getFullYear() - birthDate.getFullYear();
		const m = today.getMonth() - birthDate.getMonth();
		if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
		return age;
	}

	function lockFieldsIfYouth() {
		setTimeout(() => {
			const birthdayInput = document.getElementById("frmer_prof_@_basic_Info_@_birthday");
			if (!birthdayInput) return;
			const birthdayVal = birthdayInput.value || birthdayInput.getAttribute('value');
			if (!birthdayVal) return; 
			const age = getAgeFromBirthday(birthdayVal);
			if (age !== null && age >= 15 && age <= 35) {
				const fieldsToHide = document.querySelectorAll(
					'#section-household-head-info, #section-household-profile, #section-prod-cost, #section-workers-laborers, #section-post-harvest'
				);
				fieldsToHide.forEach(inp => { inp.style.display = 'none'; });
				Swal.fire({
					icon: 'info',
					title: 'Youth Farmer',
					text: `This farmer is ${age} years old. All fields have been hidden for youth farmers.`,
					confirmButtonText: 'OK',
					allowOutsideClick: false,
					allowEscapeKey: false
				});
			}
		}, 100);
	}

	// ======= Enable/Disable helpers =======
	function disableForm() {
		var form_data_b = $CLASS("FORM_DATA_A");
		for (var i = 0; i < form_data_b.length; i++) form_data_b[i].disabled = true;
		["submit_btn_main", "submit_btn_header", "show_mem_modal_btn", "fa1_update_btn"].forEach(btnId => {
			let btn = $ID(btnId);
			if (btn) {
				btn.disabled = true;
				btn.style.pointerEvents = "none";
				btn.style.opacity = "0.5";
			}
		});
	}

	function enableForm() {
		var form_data_b = $CLASS("FORM_DATA_A");
		for (var i = 0; i < form_data_b.length; i++) form_data_b[i].disabled = false;
		["submit_btn_main", "submit_btn_header", "show_mem_modal_btn", "fa1_update_btn"].forEach(btnId => {
			let btn = $ID(btnId);
			if (btn) {
				btn.disabled = false;
				btn.style.pointerEvents = "auto";
				btn.style.opacity = "1";
			}
		});
	}
</script>
<div id="basic_panel" style="display: none;"></div>