<style type="text/css">

	.password-container {
		position: relative;
	}

	.password-toggle {
		position: absolute;
		top: 50%;
		right: 10px;
		transform: translateY(-50%);
		cursor: pointer;
	}

	textarea,
	input[type="text"],
	input[type="number"],
	input[type="email"],
	input[type="date"],
	select {
		width: 100%;
		max-width: 100%;
		box-sizing: border-box;
	}

	textarea {
		min-height: 50px;
		max-height: 150px;
		max-width: 600px;
	}

	/* Prevent scrollbars and overflow in form containers */
	.form-section, .form-container, .form-wrapper {
		width: 80%;
		overflow-x: auto;
	}

	/* Fix display for .dataTables_wrapper or table containers */
	.dataTables_wrapper,
	.table-responsive {
		width: 100% !important;
		overflow-x: auto;
	}

	table {
		table-layout: auto;
		width: 100%;
	}
</style>

<div class="x-row">
	<h2 class="x-text-teal"><b>Farmers' Organization Profile Form</b></h2>
	<div id="form_header" class="main-title">
		<div class="x-right x-text-grey">
			Some fields aren't required to be filled up when there is no available data. You can come back and fill the fields and always check the <strong>Correct Spelling</strong> and <strong>observe the usage of special characters</strong> such as punctuation and numbers. contact the developers is you encountered an error or the input entry doesn't reflect to the dashboard or/and on the lists of entries. 
		</div>

	</div>
</div>
<div class="x-row x-container x-right">
    <b id="show_mem_modal_btn" 
       class="x-btn x-round-large x-border x-border-blue" 
       style="margin-top:5px" 
       onclick="show_mem_modal()">
        <span class="x-text-blue fa fa-users"></span>
        <span class="x-text-grey">Farmer Members</span>
    </b>

    <b id="submit_btn_main"
       class="x-btn x-round-large x-border x-border-green" 
       style="margin-top:5px"
       onclick="submit_form('form_data_b','form_b','/formbembed/e?page=list_data_table')">
        <span class="x-text-green fa fa-save"></span>
        <span class="x-text-grey">Save</span>
    </b>
</div>
<br>
<div >
	<div class="x-col m2 ">
		<!-- <div id="qrs_holder" class="x-row">
			<div class="qrs fadeIn" id="qrcode" style="max-width: 10%;"></div>
		</div>
		<hr> -->
		<div onclick="scroll_to_id('b1');scroll_to_id('b1')" class="x-zoom x-leftbar x-border-blue x-padding x-card x-block x-left  x-hover-teal x-border x-border-teal" onclick="" style="margin-top:5px">Respondent Profile</div><br>
		<div onclick="scroll_to_id('b1');scroll_to_id('b2')" class="x-zoom x-leftbar x-border-blue x-padding x-card x-block x-left  x-hover-teal x-border x-border-teal" onclick="" style="margin-top:5px">Organizational Profile</div><br>
		<div onclick="scroll_to_id('b1');scroll_to_id('b3')" class="x-zoom x-leftbar x-border-blue x-padding x-card x-block x-left  x-hover-teal x-border x-border-teal" onclick="" style="margin-top:5px">Operational Profile</div><br>
		<div onclick="scroll_to_id('b1');scroll_to_id('b4')" class="x-zoom x-leftbar x-border-blue x-padding x-card x-block x-left  x-hover-teal x-border x-border-teal" onclick="" style="margin-top:5px">FO Governance, Communication, and Planning</div><br>
		<div onclick="scroll_to_id('b1');scroll_to_id('b5')" class="x-zoom x-leftbar x-border-blue x-padding x-card x-block x-left  x-hover-teal x-border x-border-teal" onclick="" style="margin-top:5px">Administrative and financial management and human resources management</div><br>
		<div onclick="scroll_to_id('b1');scroll_to_id('b6')" class="x-zoom x-leftbar x-border-blue x-padding x-card x-block x-left  x-hover-teal x-border x-border-teal" onclick="" style="margin-top:5px">Capacity and Needs Assessment</div><br>
		<div onclick="scroll_to_id('b1');scroll_to_id('b7')" class="x-zoom x-leftbar x-border-blue x-padding x-card x-block x-left  x-hover-teal x-border x-border-teal" onclick="" style="margin-top:5px">Partnership</div><br>

	</div>
	<div class="x-col m10">
		<input class="form_data_b" id="id" type="hidden" value="">
		<div id="respondents" class="form_container x-container" style="display:block;">
			{% include "B1-Respondents.html" %}
		</div>
		<div id="organizational" class="form_container x-container" style="display:block;">
			{% include "B2-Organizational.html" %}
		</div>
		<div id="operational" class="form_container x-container" style="display:block;">
			{% include "B3-Operational.html" %}
		</div>
		<div id="fogcp" class="form_container x-container" style="display:block;">
			{% include "B4-FoGovernance.html" %}
		</div>
		<div id="admin" class="form_container x-container" style="display:block;">
			{% include "B5-Administrative.html" %}
		</div>
		<div id="capacity" class="form_container x-container" style="display:block;">
			{% include "B6-Capacity.html" %}
		</div>
		<div id="partnership" class="form_container x-container" style="display:block;">
			{% include "B7-Partnership.html" %}
		</div>

		<div id="form_header" class="main-title">
            <p class="x-left">FORM B</p>
            <p id="submit_btn_header" 
               class="x-btn x-right x-green" 
               onclick="submit_form();scroll_to_id('b1');scroll_to_id('b1')">
               Save
            </p>
        </div>
	</div>
</div>
{% include "modal_add_member.html" %}
{% include "modal_table_member.html" %}
<script src="../static/js/qr/qrcode.min.js"></script>



<script>
$onload(function () {
    var record_id = URL_ARGS["id"] || ""
    var table = URL_ARGS["table"] || "form_b"
    if(record_id){
        load_data(record_id, table, "form_data_b")
    }
})

function scrollParentToIframeCenter(){
    if (window.parent && window.frameElement){
    const iframeRect = window.frameElement.getBoundingClientRect();
    const parentScrollY = window.parent.scrollY || window.parent.pageYOffset;
    const centerY = iframeRect.top + parentScrollY + (iframeRect.height / 2) - (window.parent.innerHeight / 2);
    window.parent.scrollTo({
        top : centerY,
        behavior: 'smooth'
    });
    }
}

function submit_form(class_name, table, url) {
    var x_ins = $CLASS(class_name);
    var form_data = {};
    for (let index = 0; index < x_ins.length; index++) {
        if (x_ins[index].type === "checkbox") {
            form_data[x_ins[index].id] = x_ins[index].checked;
        } else {
            form_data[x_ins[index].id] = x_ins[index].value;
        }
    }

    $send({
        action: "/set_data_b/" + table,
        data: $DATA(form_data),
        method: POST,
        func: function (r) {
            var res = JSON.parse(r);
            println(res);

            if (res.status === "success") {
                Swal.fire({
                    title: 'Success!',
                    text: res.msg,
                    icon: 'success',
                    didOpen: () => {
                        scrollParentToIframeCenter();
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.reload();
                    }
                });
            } else {
                Swal.fire({
                    title: 'Error!',
                    text: String(res.msg),
                    icon: 'error',
                    didOpen: () => {
                        scrollParentToIframeCenter();
                    }
                });
            }
        }
    });
}


function load_data(record_id, table, class_name) {
    // http://127.0.0.1:5000/dcf/form8?id=1&table=form8
    $send({
        action: "/get_data/" + record_id + "/" + table,
        method: POST,
        func: function (r) {
            var res = JSON.parse(r)[0];
            var x_ins = $CLASS(class_name);

            function sanitizeNumber(value) {
                if (value === null || value === undefined || value === '') return '';
                // Remove non-numeric characters except dot and minus
                let clean = String(value).replace(/[^0-9.\-]/g, '');
                let num = parseFloat(clean);
                return isNaN(num) ? '' : num;
            }

            for (let index = 0; index < x_ins.length; index++) {
                let element = x_ins[index];
                let value_from_db = res[element.id];

                if (element.type === "checkbox") {
                    try {
                        element.checked = (value_from_db === "true" || value_from_db === true);
                    } catch (err) {
                        warnprintln(element.id + " ||| " + err);
                    }
                } else if (element.type === "select-one") {
                    try {
                        element.value = value_from_db || '';
                    } catch (err) {
                        warnprintln(element.id + " ||| " + err);
                    }
                } else if (element.type === "number") {
                    try {
                        element.value = sanitizeNumber(value_from_db);
                    } catch (err) {
                        warnprintln(element.id + " ||| " + err);
                    }
                } else {
                    try {
                        element.value = value_from_db || '';
                    } catch (err) {
                        warnprintln(element.id + " ||| " + err);
                    }
                }
            }
        }
    });
}
</script>

<script>
    // Automatically attach numeric-only behavior to all inputs with 'numberonly' attribute
    document.querySelectorAll('input[numberonly]').forEach(input => {
        input.addEventListener('input', function() {
            this.value = this.value.replace(/\D/g, ''); // remove non-digits
        });

        input.addEventListener('paste', function(e) {
            const pasteData = (e.clipboardData || window.clipboardData).getData('text');
            if (/\D/.test(pasteData)) e.preventDefault(); // block non-digit paste
        });
    });
</script>
<!-- ==================================================================================================== -->
