{% extends 'layouts/dcf_base.html' %}
{% set active_page = "dcf_dashboard" %}
{% block title %} Dashboard {% endblock title %}

{% block stylesheets %}{% endblock stylesheets %}

{% block content %}
{% include "includes/sweetalert.html" %}
<title>Form 11 Dashboard</title>

<div class="row">
  <div class="col-lg-4 col-md-3 col-sm-6">
    <div class="tile-stats" style="border-radius: 15px;">
      <div class="count _money_tag">{{ dcf_form11_fs_total[0]['total_farmers_with_fs'] }}</div>
      <h3>Farmer</h3>
      <p>Total # of Farmer Access the Financial Services.</p>
    </div>
  </div>

  <div class="col-lg-4 col-md-3 col-sm-6">
    <div class="tile-stats" style="border-radius: 15px;">
      <div class="count _money_tag">{{ dcf_form11_fo_total[0]['total_fos_with_fs'] }}</div>
      <h3>FO/MSME</h3>
      <p>Total # of FO/MSME access the Financial Services.</p>
    </div>
  </div>

  <div class="col-lg-4 col-md-3 col-sm-6">
    <div class="tile-stats" style="border-radius: 15px;">
      <div class="count _money_tag">0</div>
      <h3>FSPs</h3>
      <p>Total # of FSPs Extend Suitable vc.</p>
    </div>
  </div>
</div>

<style>
.dataTables_wrapper {
  overflow-x: auto;
}

#datatable-responsive th,
#datatable-responsive td {
  vertical-align: middle;
  text-align: left;
}

.truncate {
  max-width: 180px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  display: inline-block;
  vertical-align: middle;
}

#datatable-responsive td.date-cell {
  white-space: nowrap !important;
}

#datatable-responsive td,
#datatable-responsive th {
  word-wrap: break-word;
}
</style>

<div class="row">

<div class="col-md-12 col-sm-12">
  <div class="x_panel" style="border-radius: 15px;">
    <div class="x_title">
      <h2>Type of Financial Services Access by Farmer</h2>
      <ul class="nav navbar-right panel_toolbox">
        <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><i class="fa fa-wrench"></i></a>
          <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
            <a class="dropdown-item" href="#">Settings 1</a>
            <a class="dropdown-item" href="#">Settings 2</a>
          </div>
        </li>
        <li><a class="close-link"><i class="fa fa-close"></i></a></li>
      </ul>
      <div class="clearfix"></div>
    </div>

    <div class="x_content row" style="display: flex; align-items: stretch;">
      <div class="col-md-8 col-sm-8" style="display: flex; align-items: center;">
        <canvas id="mybarChartFFS" style="width: 100%; height: 100%;"></canvas>
      </div>

      <div class="col-md-4 col-sm-4" style="display: flex; align-items: center;">
        <!-- Responsive table wrapper -->
        <div class="table-responsive" style="width: 100%;">
          <table class="table table-bordered table-striped table-hover" style="margin-bottom: 0;">
            <tbody>
              <tr>
                <td><i class="fa fa-square" style="color:#009999"></i> Loans / Cash Advance</td>
                <td>{{ dcf_form11_fsls[0]['farmer_loan'] }}</td>
              </tr>
              <tr>
                <td><i class="fa fa-square" style="color:#007399"></i> Savings and Investments</td>
                <td>{{ dcf_form11_fsss[0]['farmer_savings'] }}</td>
              </tr>
              <tr>
                <td><i class="fa fa-square" style="color:#3366cc"></i> Insurance</td>
                <td>{{ dcf_form11_fsis[0]['farmer_insurance'] }}</td>
              </tr>
              <tr>
                <td><i class="fa fa-square" style="color:#33cccc"></i> Credit Guarantee</td>
                <td>{{ dcf_form11_fscs[0]['farmer_credit'] }}</td>
              </tr>
              <tr>
                <td><i class="fa fa-square" style="color:#339966"></i> Paid-Up Capital</td>
                <td>{{ dcf_form11_fspups[0]['farmer_paidup'] }}</td>
              </tr>
              <tr>
                <td><i class="fa fa-square" style="color:#993366"></i> In-Kind Grants</td>
                <td>{{ dcf_form11_fsiks[0]['farmer_inkind'] }}</td>
              </tr>
              <tr>
                <td><i class="fa fa-square" style="color:#cc6600"></i> Cash Grants</td>
                <td>{{ dcf_form11_fscgs[0]['farmer_cashgrant'] }}</td>
              </tr>
              <tr>
                <td><i class="fa fa-square" style="color:#999900"></i> Cash for Work</td>
                <td>{{ dcf_fomr11_fscfws[0]['farmer_cashforwork'] }}</td>
              </tr>
              <tr>
                <td><i class="fa fa-square" style="color:#6666cc"></i> Mortuary Insurance/Assistance</td>
                <td>{{ dcf_form11_fsms[0]['farmer_mortuary'] }}</td>
              </tr>
              <tr>
                <td><i class="fa fa-square" style="color:#cc6699"></i> Digital Platforms</td>
                <td>{{ dcf_form11_fsds[0]['farmer_digital'] }}</td>
              </tr>
              <tr>
                <td><i class="fa fa-square" style="color:#66cc66"></i> RAPID Support</td>
                <td>{{ dcf_form11_fsrs[0]['farmer_rapid'] }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="col-md-12 col-sm-12">
  <div class="x_panel" style="border-radius: 15px;">
    <div class="x_title">
      <h2>Type of Financial Services Access by FO/MSMEs</h2>
      <ul class="nav navbar-right panel_toolbox">
        <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><i class="fa fa-wrench"></i></a>
          <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
            <a class="dropdown-item" href="#">Settings 1</a>
            <a class="dropdown-item" href="#">Settings 2</a>
          </div>
        </li>
        <li><a class="close-link"><i class="fa fa-close"></i></a></li>
      </ul>
      <div class="clearfix"></div>
    </div>

    <div class="x_content row" style="display: flex; align-items: stretch;">
      <div class="col-md-8 col-sm-8" style="display: flex; align-items: center;">
        <canvas id="mybarChartFOFS" style="width: 100%; height: 100%;"></canvas>
      </div>
            <div class="col-md-4 col-sm-4" style="display: flex; align-items: center;">
        <!-- Responsive table wrapper -->
        <div class="table-responsive" style="width: 100%;">
          <table class="table table-bordered table-striped table-hover" style="margin-bottom: 0;">
            <tbody>
              <tr>
                <td><i class="fa fa-square" style="color:#009999"></i> Loans / Cash Advance</td>
                <td>{{ dcf_form11_fosls[0]['fo_loan'] }}</td>
              </tr>
              <tr>
                <td><i class="fa fa-square" style="color:#339966"></i> Equity</td>
                <td>{{ dcf_form11_foes[0]['fo_paidup'] }}</td>
              </tr>
              <tr>
                <td><i class="fa fa-square" style="color:#007399"></i> Savings and Investments</td>
                <td>{{ dcf_form11_foss[0]['fo_savings'] }}</td>
              </tr>
              <tr>
                <td><i class="fa fa-square" style="color:#3366cc"></i> Insurance</td>
                <td>{{ dcf_form11_fosis[0]['fo_insurance'] }}</td>
              </tr>
              <tr>
                <td><i class="fa fa-square" style="color:#33cccc"></i> Credit Guarantee</td>
                <td>{{ dcf_form11_foscs[0]['fo_credit'] }}</td>
              </tr>
              <tr>
                <td><i class="fa fa-square" style="color:#993366"></i> In-Kind Grants</td>
                <td>{{ dcf_form11_fosiks[0]['fo_inkind'] }}</td>
              </tr>
              <tr>
                <td><i class="fa fa-square" style="color:#cc6600"></i> Cash Grants</td>
                <td>{{ dcf_form11_foscgs[0]['fo_cashgrant'] }}</td>
              </tr>
              <tr>
                <td><i class="fa fa-square" style="color:#cc6699"></i> Digital Platforms</td>
                <td>{{ dcf_form11_fosds[0]['fo_digital'] }}</td>
              </tr>
              <tr>
                <td><i class="fa fa-square" style="color:#66cc66"></i> RAPID Support</td>
                <td>{{ dcf_form11_fosrs[0]['fo_rapid'] }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function init_charts() {
    if (typeof (Chart) === 'undefined') { return; }
    Chart.defaults.global.legend = { enabled: false };

    if ($("#mybarChartFFS").length) {
      var e = document.getElementById("mybarChartFFS");
      new Chart(e, {
        type: "bar",
        data: {
          labels: ["Loans/Cash Advance", "Savings & Investments", "Insurance", "Credit Guarantee", "Paid-Up Capital", "In-Kind Grants", "Cash Grants", "Cash for Work", "Mortuary Insurance/Assistance", "Digital Platforms", "RAPID Support"],
          datasets: [{
            label:"Total",
            backgroundColor: ["#009999", "#007399", "#3366cc", "#33cccc", "#339966", "#993366", "#cc6600", "#999900", "#6666cc", "#cc6699", "#66cc66"],
            data: [{{ dcf_form11_fsls[0]['farmer_loan'] }}, {{ dcf_form11_fsss[0]['farmer_savings'] }}, {{ dcf_form11_fsis[0]['farmer_insurance'] }}, {{ dcf_form11_fscs[0]['farmer_credit'] }}, {{ dcf_form11_fspups[0]['farmer_paidup'] }}, {{ dcf_form11_fsiks[0]['farmer_inkind'] }}, {{ dcf_form11_fscgs[0]['farmer_cashgrant'] }}, {{ dcf_fomr11_fscfws[0]['farmer_cashforwork'] }}, {{ dcf_form11_fsms[0]['farmer_mortuary'] }}, {{ dcf_form11_fsds[0]['farmer_digital'] }}, {{ dcf_form11_fsrs[0]['farmer_rapid'] }}]
          }]
        },
        options: {
          maintainAspectRatio: false,
          scales: {
            yAxes: [{
              ticks: { beginAtZero: true }
            }]
          }
        }
      });
    }

    if ($("#mybarChartFOFS").length) {
      var e = document.getElementById("mybarChartFOFS");
      new Chart(e, {
        type: "bar",
        data: {
          labels: ["Loans/Cash Advance", "Equity", "Savings and Investments", "Insurance", "Credit Guarantee", "In-Kind Grants", "Cash Grants", "Digital Platforms", "RAPID Support"],
          datasets: [{
            label:"Total",
            backgroundColor: ["#009999", "#007399", "#3366cc", "#33cccc", "#339966", "#993366", "#cc6600", "#999900", "#6666cc", "#cc6699", "#66cc66"],
            data: [{{ dcf_form11_fosls[0]['fo_loan'] }}, {{ dcf_form11_foes[0]['fo_paidup'] }}, {{ dcf_form11_foss[0]['fo_savings'] }}, {{ dcf_form11_fosis[0]['fo_insurance'] }}, {{ dcf_form11_foscs[0]['fo_credit'] }}, {{ dcf_form11_fosiks[0]['fo_inkind'] }}, {{ dcf_form11_foscgs[0]['fo_cashgrant'] }}, {{ dcf_form11_fosds[0]['fo_digital'] }}, {{ dcf_form11_fosrs[0]['fo_rapid'] }}]
          }]
        },
        options: {
          maintainAspectRatio: false,
          scales: {
            yAxes: [{
              ticks: { beginAtZero: true }
            }]
          }
        }
      });
    }
  }
</script>

<script>
function scrollParentToIframeCenter() {
  if (window.parent && window.frameElement) {
    const iframeRect = window.frameElement.getBoundingClientRect();
    const parentScrollY = window.parent.scrollY || window.parent.pageYOffset;
    const centerY =
      iframeRect.top + parentScrollY + iframeRect.height / 2 - window.parent.innerHeight / 2;

    window.parent.scrollTo({
      top: centerY,
      behavior: "smooth",
    });
  }
}

function showLoadingAndRedirect(id, table, form) {
  Swal.fire({
    title: "Loading...",
    text: "Please wait while we redirect you.",
    allowOutsideClick: false,
    allowEscapeKey: false,
    showConfirmButton: false,
    didOpen: () => {
      scrollParentToIframeCenter();
      Swal.showLoading();
      setTimeout(() => {
        window.location.href = `/dcf/${form}?id=${id}&table=${table}`;
      }, 1500);
    },
  });
}

function showDeleteConfirmation(id) {
  swalWithCustomButtons
    .fire({
      title: "Are you sure?",
      text: "You won't be able to revert this!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Yes, delete it!",
      cancelButtonText: "No, cancel",
      reverseButtons: true,
      position: "center",
      didOpen: () => {
        scrollParentToIframeCenter();
      },
      customClass: {
        confirmButton: "btn btn-success",
        cancelButton: "btn btn-danger",
      },
    })
    .then((result) => {
      if (result.isConfirmed) {
        window.location.href = `/delete_record/dcf_access_financing/${id}`;
      } else if (result.dismiss === Swal.DismissReason.cancel) {
        swalWithCustomButtons.fire({
          title: "Cancelled",
          text: "Your record is safe",
          icon: "error",
          position: "center",
          didOpen: () => {
            scrollParentToIframeCenter();
          },
        });
      }
    });
  return false;
}

const swalWithCustomButtons = Swal.mixin({
  customClass: {
    confirmButton: "btn btn-success",
    cancelButton: "btn btn-danger",
  },
  buttonsStyling: false,
});

function download_login_start(fff) {
  let a = document.createElement("a");
  a.target = "_blank";
  a.href = "/login/download_file/" + fff;
  a.click();
}
</script>

<!-- ✅ Data Table -->
<div class="col-md-12 col-sm-12">
  <div class="x_panel" style="border-radius: 15px;">
    <div class="x_title">
      <h2>Data <small>Access to Financing Dashboard</small></h2>
      <ul class="nav navbar-right panel_toolbox">
        <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
            <i class="fa fa-wrench"></i>
          </a>
          <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
            <a class="dropdown-item" href="#">Settings 1</a>
            <a class="dropdown-item" href="#">Settings 2</a>
          </div>
        </li>
        <li><a class="close-link"><i class="fa fa-close"></i></a></li>
      </ul>
      <div class="clearfix"></div>
    </div>

    <div class="x_content">
      <div class="row">
        <div class="col-sm-12">
          <div class="card-box table-responsive">
            <p class="text-muted font-13 m-b-30">
              All entries of Form 11 are displayed below. Records are labeled based on whether they belong to a <strong>Farmer</strong> or <strong>FO/MSME</strong>.
            </p>

            <table id="datatable-responsive" class="table table-striped table-bordered table-hover" cellspacing="0" width="100%">
              <thead style="background-color: #007399; color: white">
                <tr>
                  <th>ID</th>
                  <th>Region</th>
                  <th>Province</th>
                  <th>DIP Name</th>
                  <th>FO/MSME Name</th>
                  <th>Farmer Name</th>
                  <th>Action</th>
                  <th>Timestamp</th>
                </tr>
              </thead>
              <tbody>
                {% for row in form11_datatable %}
                <tr>
                  <!-- ID -->
                  <td>{{ row['id'] }}</td>

                  <!-- Region -->
                  <td>
                    {% set region_display = row['form_11_farmer_region'] or row['form_11_fo_msme_regional'] %}
                    <span class="truncate" title="{{ region_display }}">{{ region_display }}</span>
                  </td>

                  <!-- Province -->
                  <td>
                    {% set province_display = row['form_11_farmer_pcu'] or row['form_11_fo_msme_pcu'] %}
                    <span class="truncate" title="{{ province_display }}">{{ province_display }}</span>
                  </td>

                  <!-- DIP Name -->
                  <td>
                    {% set dip_display = row['form_11_farmer_dip_name'] or row['form_11_fo_dip_name'] %}
                    <span class="truncate" title="{{ dip_display }}">{{ dip_display }}</span>
                  </td>

                  <!-- FO/MSME Name -->
                  <td>
                    {% set fo_name = row['form_11_fo_name_of_beneficiary'] or '' %}
                    <span class="truncate" title="{{ fo_name }}">{{ fo_name }}</span>
                  </td>

                  <!-- Farmer Name -->
                  <td>
                    {% set farmer_name = row['form_11_farmer_beneficiaries_name'] or '' %}
                    <span class="truncate" title="{{ farmer_name }}">{{ farmer_name }}</span>
                  </td>

                  <!-- Action -->
                  <td>
                    {% if row['upload_by']|string == user_data['id']|string %}
                      <a style="color: #00e673;" href="javascript:void(0);" onclick="showLoadingAndRedirect('{{ row['id'] }}', 'dcf_access_financing', 'form11');">
                        <i class="fa fa-pencil-square-o"></i> Edit
                      </a><br>
                      <a style="color: #ffc34d; cursor: pointer;" onclick='goto("feature_0/link_data_dcf_form_a?&h="+{{ row["id"] }}+"&i=dcf_access_financing",true)'>
                        <i class="fa fa-user-plus"></i> Add Participants
                      </a><br>
                      <a style="color: #ff5c33;" onclick="showDeleteConfirmation('{{ row['id'] }}'); return false;" href="/delete_record/dcf_access_financing/{{ row['id'] }}">
                        <i class="fa fa-trash"></i> Delete
                      </a>
                    {% else %}
                      <a style="color: #33cccc;" href="javascript:void(0);" onclick="showLoadingAndRedirect('{{ row['id'] }}', 'dcf_access_financing', 'form11');">
                        <i class="fa fa-eye" aria-hidden="true"></i> View
                      </a>
                    {% endif %}
                  </td>

                  <!-- Timestamp -->
                  <td class="date-cell">
                    {{ row['date_created'] }}<br>
                    {% if row['date_modified'] %}
                      <i style="font-size: smaller; color: #00cc66;">Updated: {{ row['date_modified'] | format_timestamp }}</i>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ✅ Filtering Script -->
<script>
  function populateDipNames(selectElementId, region = '') {
    const url = region
      ? `/api/get_dip_names_by_region?region=${encodeURIComponent(region)}`
      : '/api/get_dip_names';

    return fetch(url)
      .then(response => {
        if (!response.ok) {
          return response.text().then(text => { throw new Error(text) });
        }
        return response.json();
      })
      .then(data => {
        const selectElement = document.getElementById(selectElementId);
        selectElement.innerHTML = '<option value="">Choose your option</option>';
        data.forEach(item => {
          const option = document.createElement('option');
          option.value = item.form_1_name_dip;
          option.textContent = item.form_1_name_dip;
          selectElement.appendChild(option);
        });
      })
      .catch(error => {
        console.error(`Error fetching DIP names for ${selectElementId}:`, error);
      });
  }

  populateDipNames('form_11_fo_dip_name');
  populateDipNames('form_11_farmer_dip_name');

  document.getElementById('form_11_farmer_region')?.addEventListener('change', function() {
    const region = this.value;
    const dipDropdown = document.getElementById('form_11_farmer_dip_name');
    dipDropdown.innerHTML = '<option value="">Choose your option</option>';
    if (!region) return populateDipNames('form_11_farmer_dip_name');
    populateDipNames('form_11_farmer_dip_name', region);
  });

  document.getElementById('form_11_fo_msme_regional')?.addEventListener('change', function() {
    const region = this.value;
    const dipDropdown = document.getElementById('form_11_fo_dip_name');
    dipDropdown.innerHTML = '<option value="">Choose your option</option>';
    if (!region) return populateDipNames('form_11_fo_dip_name');
    populateDipNames('form_11_fo_dip_name', region);
  });
</script>

<script type="text/javascript">
	function exportForm11Data() {
		window.location.href = '/export_form11'; 
	}
</script>

<div class="col-md-12 col-sm-12 ">
  <div class="x_panel tile" style="border-radius: 15px;">
	<div class="x_title">
	  <h2>FORM 11 ACCESS TO FINANCING TRACKER <small>SPREADSHEET MANAGEMENT</small></h2>
	  <ul class="nav navbar-right panel_toolbox">
		<li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
		</li>
		<li class="dropdown">
		  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><i class="fa fa-wrench"></i></a>
		  <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
			  <a class="dropdown-item" href="#">Settings 1</a>
			  <a class="dropdown-item" href="#">Settings 2</a>
		  </div>
	  </li>
	  <li><a class="close-link"><i class="fa fa-close"></i></a>
	  </li>
  </ul>
  <div class="clearfix"></div>
</div>
<div class="x_content">
	<form action="/dcf" method="POST" enctype="multipart/form-data">
	  <div class="form-group">
		<div class="form-row">
		  <div class="col">
			<select id="export_type" name="export_type" class="form-control">
			  <option value="form11export">FORM 11 ACCESS TO FINANCING TRACKER</option>
		  </select>
	  </div>
  </div>
  <div class="form-row">
	  <div class="col">
		<strong>
		  <label for="position">Export Data:</label>
	  </strong><br>
	  	<button type="button" class="btn btn-md btn-dark" onclick="exportForm11Data()">
			<span><i class="fa fa-cloud-download"></i></span> Export Form 11
		</button>
	  <!--<button type="submit" class="btn btn-md btn-dark"><span><i class="fa fa-cloud-download"></i></span>
	  Export</button>-->
  </div>
</div>
</div>
</form>
<form action="/importcsvform11" method="POST" enctype="multipart/form-data">
  {% include "includes/sweetalert.html" %}
  <div class="form-group">
	<div class="form-row">
	  <div class="col">
			<strong>
				<label for="position">Import Data:</label>
			</strong><br>
			<div class="file-upload">
				<div class="file-select">
					<div class="file-select-button" id="fileName">Choose File</div>
					<div class="file-select-name" id="noFile">No file chosen...</div>
					<input multiple type="file"
					accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel"
					name="chooseFile" id="chooseFile" required>
				</div>
			</div>
			<br>
				<button type="submit" class="btn btn-info btn-xs"><span><i class="fa fa-upload"></i></span> Import</button>
				<span style="cursor: pointer;" onclick="download_login_start('DCF_Form_11.xlsx')" class="btn btn-success btn-xs"><i class="fa fa-file-text" aria-hidden="true"></i> Download form 11 excel template</span>
		</div>
	</div>
</form>

</div>
</div>
</div>
<!-- End to do list -->
<!-- end of weather widget -->
</div>
</div>
</div>
{% endblock content %}
<!-- Specific JS goes HERE -->
{% block javascripts %}
{% endblock javascripts %}