<!DOCTYPE html>
<html>
	<head>
		
		<!-- Required meta tags -->
		<meta charset="utf-890" lang="en-us">
		<script src="../../static/js/Brorn.min.js"></script>
		<!-- Bootstrap CSS -->
		<link rel="stylesheet" href="../../static/webrepstatic/css/autofill.css">
		<link rel="icon" href="../static/img/icon.png">
		<link rel="stylesheet" href="../../static/webrepstatic/css/style.css"><!-- fontawesomeCDN -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha512-MV7K8+y+gLIBoVD59lQIYicR65iaqukzvf/nwasF0nqhPay5w/9lJmVM2hMDcnK1OnMGCdVK+iQrJ7lzPJQd1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />     
		<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Jost:wght@500;600&display=swap" rel="stylesheet">

		<!-- fontawesomeCDN -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css"/>		
		<script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>

		<!-- CSS only -->
		<link href="../../static/webrepstatic/css/bootstrap.min.css" rel="stylesheet">

		<!-- JavaScript Bundle with Popper -->
		<script defer src="../../static/webrepstatic/js/bs@5.2.3/bootstrap.bundle.min.js"></script>
		<script src="../../static/webrepstatic/js/bootstrap-autocomplete.min.js"></script>
		<!-- drag & drop file -->

		<link href="https://transloadit.edgly.net/releases/uppy/v1.6.0/uppy.min.css" rel="stylesheet">
		<script src="https://transloadit.edgly.net/releases/uppy/v1.6.0/uppy.min.js"></script>


		<title>MIS Forum | {{forum['topic']}}</title>
	</head>

<body>

<!-- NAVBAR -->
<nav class=" navbar navbar-expand-lg fixed-top bg-white">
	<div class="container-fluid">
		<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarTogglerDemo03" aria-controls="navbarTogglerDemo03" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
		</button>
		<a class="navbar-brand d-flex ms-5" href="#">
		 <img src="../../static/img/mis_2023_v2.svg" width="50" height="50" class="d-inline-block align-top small" alt="">
		 <span class="align-self-center ms-2 small">forum</span>
	</a>
		<div class="collapse navbar-collapse" id="navbarTogglerDemo03">
			<ul class="navbar-nav mx-auto mb-2 mb-lg-0">
				<li class="nav-item">
					<a class="nav-link active" aria-current="page" href="/forum">Topic</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" href="#">Participants</a>
				</li>
			</ul>
			<form class="d-flex" role="search">
				<input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
				<button class="btn btn-outline-success" type="submit">Search</button>
			</form>
		</div>
	</div>
</nav>

<div class="bg-light" style="min-height:9000px; background-color: #e3ebd5 !important;">
	<div class="" style="min-height: 150px;"></div>
	<div class=" container texttheme bg-white pt-5 px-5 pb-5 rounded-2">
		<!-- {{forum}} -->
		<h1 class="">{{forum['topic']}}</h1>			
		<div class="container bg-light rounded-2" >
			<div class="d-flex justify-content-between pt-4 container text-white">
				<div class="d-flex gap-3">
					<p class="small">Posted by {{forum['uploader']}}</p>
					<p class="xs-text align-self-center">{{forum['date_created']}}</p>
				</div>
				<div>
					<p class="small"><i class="fa-solid fa-eye"></i>&nbsp; <b id="num_participants"></b> people</p>	
				</div>
				</div>
				<div class="container">
					<i id="participants" class="xs-text"></i>
				</div>
				<div class="container mt-3 pb-5">
					<p class="">
						{{forum['description']}}
					</p>
				</div>
			</div>
			<div class="container mt-1 d-flex gap-3">
				<!-- <div class="d-flex gap-3">
					<p class="small "><i class="fa-solid fa-thumbs-up" style="color: #81a352;"></i>&nbsp;57 Likes</p>	
				</div> -->
				<div>
					<p class="small "><i class="fa-solid fa-message"></i>&nbsp;<b id="com_count"></b> comment/s</p>
				</div>
			</div>
			<!-- Reply -->
			<div id="reply_container">
				<div class=" d-flex">
					<div class="px-2">
						<i class="fa-solid">Loading. . .</i>
					</div>
				</div>
			</div>
			<div id="input_rep_container" class="container">
				<input type="text" id="id" hidden>
				<input type="text" id="comment" name="comment" class="REPLY_DATA input form-control" placeholder="Input your commnet/Reply">
				<button type="submit" class="btn btn-primary" onclick="send_comment()">Send</button>
			</div>
			<!-- ===== -->
		</div>
	</div>	
</div>
<script type="text/javascript">
	function send_comment(){
		var REPLY_DATA_INP = $DATA({"comment" : $ID("comment").value,"topic_id" : "{{forum['id']}}","comment_by" : "{{USER_DATA['id']}}","id":$ID("id").value})
		$send({
			action : "/forum/send_comment",
			data : REPLY_DATA_INP,
			method : POST,
			func : function(r){
				var res = JSON.parse(r)
				$ID("comment").value = ""
				$ID("id").value = ""
				load_comments()
			}
		})
	}

	function edit_comment(ids,comm_edt){
		$ID('input_rep_container').scrollIntoView()
		$ID("comment").value = comm_edt
		$ID("id").value = ids
	}

	$onload(load_comments,function(){
		window.setInterval(load_comments,5000)
	})
	function load_comments(){
		$send({
			action : "/forum/get_comment/{{forum['id']}}",
			func : function(r){
				var ls_comments = JSON.parse(r)[0]
				var ls_participants = JSON.parse(r)[1]
				$ID("participants").innerHTML = ""
				for (var i = 0; i < ls_participants.length; i++) {
					$ID("participants").innerHTML +=(`
						<span>`+ls_participants[i]['commenter']+`, </span>
					`)
				}

				$ID("num_participants").innerHTML= ls_participants.length
				$ID("com_count").innerHTML = ls_comments.length
				var com_cards = ""
				$ID("reply_container").innerHTML="Loading"
				for (var i = 0; i < ls_comments.length; i++) {
					var com = ls_comments[i]
					var edit_btn = "" ;
					var rm_conts = "none" ; var com_conts = "block"
					var commenter = "someone"
					{% if USER_DATA['job']=="Admin" or USER_DATA['job']=="Super Admin" %}
					/**/if(true){
					{% else %}
					/**/if(com['comment_by']=="{{USER_DATA['id']}}"){
							commenter = "You"
					{% endif %}
						edit_btn = (`
							<span class='small text-danger' onclick="del_comment('`+com['id']+`')">Delete Comment</span>&nbsp; | &nbsp;
							<span class='small text-primary' onclick="edit_comment('`+com['id']+`','`+com['comment']+`')">Edit Comment</span>&nbsp; | &nbsp;
						`)
					}else{
						commenter = com['commenter']
						if(com['edit']=="1"){
							edit_btn ="<span class='small text-secondary'>Edited comment</span>&nbsp; | &nbsp;"
						}else{
							edit_btn =""
						}
					}


					if(com['removed']=="1"){
						rm_conts = "<span class='text-danger'> removed a comment</span";
						com_conts = "";
					}else{
						rm_conts = "replied";
						com_conts = (`
							<div>
								<div class="container pb-3">
									<p class="">`+urlify(com['comment'])+` </p>
								</div>
								<div class="container text-end">
									`+edit_btn+`
									<span class="small ">
										<i id="lk_btn" class="fs-5 fa-solid fa-thumbs-up" style="color:red;" onclick="send_com_likes('`+com['id']+`')"></i>
										&nbsp;`+com['likes']+`
									</span>
								</div>
							</div>
						`)
					}


					com_cards +=(`
						<div class=" d-flex">
							<div class="px-2">
								<i class="fa-solid fa-reply"></i>
							</div>
							<div class="container bg-light rounded-2" >
								<div class="d-flex justify-content-between pt-4 container text-white">
									<div class="d-flex gap-3">
										<p class="small">`+commenter+` `+rm_conts+`</p>
										<p class="xs-text align-self-center">`+com['date']+`</p>
									</div>
								</div>
								`+com_conts+`
							</div>
						</div><br> `)
				}
				$ID("reply_container").innerHTML=com_cards
			}
		})
	}

	function del_comment(ids){
		$send({
			action : "/forum/delete_comment/"+ids,
			func : function(r){
				var res = JSON.parse(r)
				println(res)
				load_comments()
			}
		})
	}
	function send_com_likes(ids){
		$send({
			action : "/forum/send_comment_like/"+ids,
			func : function(r){
				var res = JSON.parse(r)
				// println(res)
			}
		})
	}

	function urlify(text) {
		var urlRegex = /(((https?:\/\/)|(www\.))[^\s]+)/g;
		return text.replace(urlRegex, function(url) {
			return `<a href="#"  target="_blank" onclick="goto('`+ url +`')">`+ url +`</a>`;
		})
		// or alternatively
		// return text.replace(urlRegex, '<a href="$1">$1</a>')
	}
</script>
</body>
</html>