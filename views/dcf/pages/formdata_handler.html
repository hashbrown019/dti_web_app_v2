<script>
$(document).ready(function(){
$(".hidden-textbox").hide();
$("select#form_1_commodity,select#form_2_commodity,select#cbb_commodity,select#mgit_commodity,select#form_6_commodity,select#form_7_commodity,select#form_11_industry_cluster").change(function(){
var currentVal = $(this).val();
if(currentVal == "PFN"){
$(".hidden-textbox").show();
}
else
$(".hidden-textbox").hide();
});  
});

// function edit_form(class_name,table){
// 	for (let index = 0; index < $CLASS('class_name').length; index++) {
// 		const element = $CLASS('class_name')[index].disabled = false
// 	}
// }


function load_data(record_id,table,class_name){
	// http://127.0.0.1:5000/dcf/form8?id=1&table=form8
	$send({
		action : "/get_data/"+record_id+"/"+table,
		method : POST,
		func : function(r){
			var res = JSON.parse(r)[0]
			var x_ins = $CLASS(class_name)
			for (let index = 0; index < x_ins.length; index++) {
				// x_ins[index].value = res[x_ins[index].id]
				if (x_ins[index].type == "checkbox") {
					try{
						if (res[x_ins[index].id] === "true") {
							x_ins[index].click()
						}
					}catch(err){
						warnprintln(x_ins[index].id + " ||| " + err)
					}
				} else if (x_ins[index].type == "select-one" || x_ins[index].type == "select-multiple") {
					// println(res[x_ins[index].id].split(","))
					// println(CHOICES_SELECT)
					// println(CHOICES_SELECT[x_ins[index].id])
					try{
						if(CHOICES_SELECT[x_ins[index].id] != undefined){
							// alert("kamown")
							var _val = res[x_ins[index].id].split(",")
							println(_val)
							CHOICES_SELECT[x_ins[index].id].setValue(_val);
							x_ins[index].value = res[x_ins[index].id]

						}else{
							// println(x_ins[index].classList)
							x_ins[index].value = res[x_ins[index].id]
						}
					}catch(err){
						warnprintln(x_ins[index].id + " ||| " + err)
					}

				} else {
					try {
						x_ins[index].value = res[x_ins[index].id]
					} catch (error) {
						warnprintln(x_ins[index].id + " ||| " + error)
					}
				}
				var USER_ID = JSON.parse('{{user_data}}'.replaceAll('&#39;','"'))['id']
				if(USER_ID==parseInt(res['upload_by'])){
					x_ins[index].disabled = false;try{CHOICES_SELECT[x_ins[index].id].enable()}catch(e){warnprintln(e)}
					
				}else{
					x_ins[index].disabled = true;try{CHOICES_SELECT[x_ins[index].id].disable()}catch(e){warnprintln(e)}
					try{
						$ID('submit_btn_holder').innerHTML = "<br><i style='font-size: medium; font-weight: bolder; 'class='x-text-red'><i class='fa-solid fa-circle-exclamation'></i> This record is not yours </i>"
						$ID('head_note').innerHTML = "<i style='font-size: small; color:#ffb366; font-weight: bold; 'class='x-text'><i class='fa-solid fa-circle-exclamation'></i> This record is not yours <br> Editing is Disabled.</i>"
					}catch(e){
						warnprintln(e)
					}
				}
			}
			dom_refresh();
			for (let index = 0; index < x_ins.length; index++) {
				// x_ins[index].value = res[x_ins[index].id]
				if(x_ins[index].getAttributeNames().includes("show-base") && x_ins[index].getAttributeNames().includes("show-trigger")){
					var base_id = x_ins[index].getAttribute("show-base")
					var child_id_value = x_ins[index].getAttribute("show-trigger")
					var base_id_value = $ID(base_id).value
					println(base_id_value + " = " + child_id_value)
					if(base_id_value == child_id_value){
						println(x_ins[index])
						x_ins[index].style.display = "block";
						dom_refresh();
					}
				}
			}
			// "choices__button"
			// var choices__list =$CLASS("choices__input")
			// for (let index = 0; index < choices__list.length; index++) {
			// 	choices__list[index].disabled = true;
				
			// }
			dom_refresh();
		}
	})
}


function triggerChange(element) {
	let changeEvent = new Event('change');
	element.dispatchEvent(changeEvent);
}




function submit_form(class_name,table, url){
	var x_ins = $CLASS(class_name);var form_data = {}
	for (let index = 0; index < x_ins.length; index++) {
		var VAL = ""
		if(x_ins[index].classList.contains("choices__input")){
			var temp = x_ins[index]
			var element = []
			for (let xxx = 0; xxx < temp.length; xxx++) {
				element.push(temp[xxx].innerHTML);
			}
			VAL = element.toString()
		}
		else{
			VAL = x_ins[index].value
		}
		form_data[x_ins[index].id] =  VAL
	}

	var temp_data = [] ;var temp_form_data = {}
	for(key in form_data){
		if(key.includes('_kapown_')){
			var temp_id = key.split("_kapown_")
			var orig_id = key.split("_kapown_")[0]
			temp_data.push(form_data[key])
			if(temp_form_data[orig_id]==undefined){temp_form_data[orig_id] = []}
			temp_form_data[orig_id].push(form_data[key])
			println(orig_id)
			delete form_data[key]

		}
	}
	for(_temp in temp_form_data){
		temp_form_data[_temp] = temp_form_data[_temp].join(',')
	}
	form_data = Object.assign({}, temp_form_data, form_data);
	println(form_data)

	$send({
			action: "/set_data/" + table,
			data: $DATA(form_data),
			method: POST,
			func: function (r) {
				var res = JSON.parse(r)
				println(res)
				if (res.status == "success") {
					Swal.fire(
						'Success!',
						'Record Saved!',
						'success'
					).then((result) => {
						if (result.isConfirmed) {
							window.location.href = url;
						}
					});
				}
			}
		})
	println(form_data)
}
</script>